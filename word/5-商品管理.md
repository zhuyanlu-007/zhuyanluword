# 五,商品管理

## 1.centos下安装fastDFS

解压fastDFS压缩包.得到压缩文件

在linux系统中自己的目录下新建fastDFS目录

```
mkdir fastDFS
```

![image-20210108184748315](C:\Users\lulu\AppData\Roaming\Typora\typora-user-images\image-20210108184748315.png)

进入fastDFS目录

```
cd fastDFS/
```

将刚刚解压得到的压缩包全部上传到此文件内

![image-20210108184821698](C:\Users\lulu\AppData\Roaming\Typora\typora-user-images\image-20210108184821698.png)

**安装C/C++ 编译环境**

```
yum -y install gcc gcc-c++ autoconf pcre pcre-devel make automake
```

![image-20210108184851264](C:\Users\lulu\AppData\Roaming\Typora\typora-user-images\image-20210108184851264.png)

**安装libevent**

```
yum -y install libevent
```

![image-20210108184910963](C:\Users\lulu\AppData\Roaming\Typora\typora-user-images\image-20210108184910963.png)

**安装 libfastcommon**

```
tar -xvf libfastcommon-master.tar #解压压缩包
cd libfastcommon-master/ #进入目录
./make.sh #编译
```

![image-20210108185057184](C:\Users\lulu\AppData\Roaming\Typora\typora-user-images\image-20210108185057184.png)

```
./make.sh install #安装
cp /usr/lib64/libfastcommon.so /usr/lib #复制镜像
```

![image-20210108185130894](C:\Users\lulu\AppData\Roaming\Typora\typora-user-images\image-20210108185130894.png)



**安装FastDFS**

```
cd .. #进入fastDFS目录
tar -zxvf FastDFS_v5.08.tar.gz #解压压缩包
cd FastDFS/ #进入目录
./make.sh #编译
./make.sh install #安装
```

**启动tracker**

```
cd /etc/fdfs #进入fastDFS配置目录
cp tracker.conf.sample tracker.conf #复制文件
vi tracker.conf #编辑刚刚复制的配置文件
```

**修改配置**

```
base_path=/shop/fdfs/tracker
```

![image-20210108185202894](C:\Users\lulu\AppData\Roaming\Typora\typora-user-images\image-20210108185202894.png)

**保存并退出文件**

** **创建刚刚设置的目录****

```
mkdir -p /shop/fdfs/tracker
```

**启动tracker**

```
service fdfs_trackerd start #停止换成stop
```

![image-20210108185246868](C:\Users\lulu\AppData\Roaming\Typora\typora-user-images\image-20210108185246868.png)

**启动storage**

```
cp storage.conf.sample storage.conf
vi storage.conf
```

**修改配置**

```
base_path=/shop/fdfs/storage
store_path0=/shop/fdfs/storage
tracker_server=本机ip地址:22122 #注意不能写localhost,需要写ip地址
```

![image-20210108185307573](C:\Users\lulu\AppData\Roaming\Typora\typora-user-images\image-20210108185307573.png)

**保存并退出 创建刚刚设置的目录**

```
mkdir -p /shop/fdfs/storage
```

启动storage

```
service fdfs_storaged start
```

![image-20210108185325841](C:\Users\lulu\AppData\Roaming\Typora\typora-user-images\image-20210108185325841.png)

查看进程

```
ps -ef | grep fdf
```

![image-20210108185341150](C:\Users\lulu\AppData\Roaming\Typora\typora-user-images\image-20210108185341150.png)

#### 安装FastDFS的Nginx模块

进入压缩包所在的目录

![image-20210108185409561](C:\Users\lulu\AppData\Roaming\Typora\typora-user-images\image-20210108185409561.png)

```
tar -zxvf fastdfs-nginx-module_v1.16.tar.gz #解压压缩包
cd fastdfs-nginx-module/src/ #进入目录
vi config
//直接输入下面的命令,注意冒号需要手敲
: --> %s+/usr/local/+/usr/+g --> enter --> esc --> :wq --> enter
```

保存并退出

```
cp mod_fastdfs.conf /etc/fdfs/ #复制文件
vi /etc/fdfs/mod_fastdfs.conf
```

修改默认配置

```
connect_timeout=10
tracker_server=本机ip地址:22122 #不能写localhost
url_have_group_name = true
store_path0=/shop/fdfs/storage
```

![image-20210108185425939](C:\Users\lulu\AppData\Roaming\Typora\typora-user-images\image-20210108185425939.png)

![image-20210108185441263](C:\Users\lulu\AppData\Roaming\Typora\typora-user-images\image-20210108185441263.png)

保存并退出

 进入FastDFS/conf目录

![image-20210108185501472](C:\Users\lulu\AppData\Roaming\Typora\typora-user-images\image-20210108185501472.png)

```
cp http.conf mime.types /etc/fdfs/ #复制文件
```

#### 安装Nginx

进入压缩包所在的目录

![image-20210108185515663](C:\Users\lulu\AppData\Roaming\Typora\typora-user-images\image-20210108185515663.png)

```
tar -zxvf nginx-1.10.0.tar.gz #解压压缩包
yum -y install make zlib-devel libtool openssl openssl-devel #安装依赖
cd nginx-1.10.0/
./configure --prefix=/opt/nginx --sbin-path=/usr/bin/nginx --addmodule=/jlz/fastDFS/fastdfs-nginx-module/src
```

注意: 

--prefix= --> nginx配置文件所在目录

 --sbin-path= --> 执行程序文件所在目录 

--add-module= -->外部模块路径，启用对外部模块的支持 这个路径一定不能配置错,就写你自己 fastdfs-nginx-module的目录即可

```
make && make install #编译并安装
```

![image-20210108185535750](C:\Users\lulu\AppData\Roaming\Typora\typora-user-images\image-20210108185535750.png)

编辑nginx的配置文件

```
vi /opt/nginx/conf/nginx.conf
```

server的配置

```
listen 80;
server_name localhost:8888;#storage的端口号
# 监听域名中带有group的，交给FastDFS模块处理
location ~/group([0-9])/ {
ngx_fastdfs_module;
}
```

保存并退出

```
cd /opt/nginx #nginx主目录
```

![image-20210108185553285](C:\Users\lulu\AppData\Roaming\Typora\typora-user-images\image-20210108185553285.png)

启动nginx

```
nginx
nginx -s stop #停止
nginx -s reload #重新加载配置
```

![image-20210108185609171](C:\Users\lulu\AppData\Roaming\Typora\typora-user-images\image-20210108185609171.png)

浏览器输入ip地址访问

![image-20210108185625866](C:\Users\lulu\AppData\Roaming\Typora\typora-user-images\image-20210108185625866.png)

成功！！！！

## 2.java上传文件到fastDFS服务

**mingrui-shop-basics:** 

**mingrui-shop-basic-upload-server**

**pom.xml**

```
<!--        fastDFS服务-->
        <dependency>
            <groupId>com.github.tobato</groupId>
            <artifactId>fastdfs-client</artifactId>
            <version>1.26.1-RELEASE</version>
        </dependency>
```

application.yml

```yml
fdfs:
  so-timeout: 1501
  connect-timeout: 601
  thumb-image: # 缩略图
    width: 60
    height: 60
  tracker-list: # tracker地址
    - 119.45.210.115:22122
mingrui:
  upload:
    path:
      windows: E:\\images
      linux: /zhuyanlu/images
    img:
      host: http://119.45.210.115/
```

**新建config包下新建配置类FastClientImporter**

```java

import com.github.tobato.fastdfs.FdfsClientConfig;
import org.springframework.context.annotation.Configuration;
import org.springframework.context.annotation.EnableMBeanExport;
import org.springframework.context.annotation.Import;
import org.springframework.jmx.support.RegistrationPolicy;

@Configuration
@Import(FdfsClientConfig.class)
// 解决jmx重复注册bean的问题
@EnableMBeanExport(registration = RegistrationPolicy.IGNORE_EXISTING)
public class FastClientImporter {
}
```

新建FastDFSUploadController上传文件controller

```java

import com.baidu.shop.base.Result;
import com.baidu.shop.status.HTTPStatus;
import com.github.tobato.fastdfs.domain.StorePath;
import com.github.tobato.fastdfs.domain.ThumbImageConfig;
import com.github.tobato.fastdfs.service.FastFileStorageClient;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.multipart.MultipartFile;

import java.io.IOException;
import java.io.InputStream;
@RestController
@RequestMapping(value = "upload")
@Slf4j
public class FastDFSUploadController {
    //图片服务器的地址
    @Value(value = "${mingrui.upload.img.host}")
    private String imgHost;

    // 负责存储图片的客户端
    @Autowired
    private FastFileStorageClient storageClient;

    //缩略图配置
    @Autowired
    private ThumbImageConfig thumbImageConfig;

    @PostMapping
    public Result<String> uploadImg(@RequestParam MultipartFile file) throws IOException {

        InputStream inputStream = file.getInputStream();//获取文件输入流(二进制字节流)
        String filename = file.getOriginalFilename();//文件名
        //1.aa.jpg substring 要头不要尾
        String ex = filename.substring(filename.lastIndexOf(".") + 1);//文件后缀名
        // 上传并且生成缩略图
        StorePath storePath = this.storageClient.uploadImageAndCrtThumbImage(
                inputStream, file.getSize(), ex, null);//上传
        // 带分组的路径
        log.info("上传图片全路径:{}", storePath.getFullPath());
        // 不带分组的路径
        log.info("上传图片路径:{}", storePath.getPath());
        // 获取缩略图路径
        String path = thumbImageConfig.getThumbImagePath(storePath.getFullPath());
        log.info("缩略图路径:{}", path);

        return new Result<String>(HTTPStatus.OK,"上传成功",imgHost + path);
    }

}
```

将UploadController中所有注释注掉或删除UploadController

postman测试

浏览器输入http://119.45.210.115/group1/M00/00/00/Cs4ADV_0fGGATilgAAIUzJRKgKA734_60x60.jpg

出现图片成功！！

## 3.商品管理(查询)

### 后台

mingrui-shop-service-api-xxx

com.baidu.shop.entity：新建 SpuEntity

```java
package com.baidu.shop.entity;

import lombok.Data;

import javax.persistence.Id;
import javax.persistence.Table;
import java.util.Date;

@Table(name = "tb_spu")
@Data
public class SpuEntity {
    @Id
    private Integer id;

    private String title;

    private String subTitle;

    private Integer cid1;

    private Integer cid2;

    private Integer cid3;

    private Integer brandId;

    private Integer saleable;

    private Integer valid;

    private Date createTime;

    private Date lastUpdateTime;
}
```

com.baidu.shop.dto：新建SpuDto

```java
package com.baidu.shop.dto;

import com.baidu.shop.base.BaseDTO;
import com.baidu.shop.validate.group.MingruiOperation;
import io.swagger.annotations.ApiModel;
import io.swagger.annotations.ApiModelProperty;
import lombok.Data;

import javax.validation.constraints.NotNull;
import java.util.Date;

@ApiModel(value = "spu传输DTO")
@Data
public class SpuDto extends BaseDTO {
    @ApiModelProperty(value = "主键",example = "1")
    @NotNull(message = "主键不能为空",groups = {MingruiOperation.Update.class})
    private Integer id;

    @ApiModelProperty(value = "标题")
    @NotNull(message = "标题不能为空",groups = {MingruiOperation.Add.class})
    private String title;

    @ApiModelProperty(value = "子标题")
    @NotNull(message = "子标题不能为空",groups = {MingruiOperation.Add.class})
    private String subTitle;

    @ApiModelProperty(value = "1级类录id",example = "1")
    @NotNull(message = "1级类录id不能为空",groups = {MingruiOperation.Add.class})
    private Integer cid1;

    @ApiModelProperty(value = "2级类录id",example = "1")
    @NotNull(message = "2级类录id不能为空",groups = {MingruiOperation.Add.class})
    private Integer cid2;

    @ApiModelProperty(value = "3级类录id",example = "1")
    @NotNull(message = "3级类录id不能为空",groups = {MingruiOperation.Add.class})
    private Integer cid3;

    @ApiModelProperty(value = "商品所属品牌id",example = "1")
    @NotNull(message = "商品所属品牌id不能为空",groups = {MingruiOperation.Add.class})
    private Integer brandId;

    //不需要验证,新增时直接设置默认值
    @ApiModelProperty(value = "是否上架，0下架，1上架",example = "1")
    private Integer saleable;

    //不需要验证,新增时直接设置默认值
    @ApiModelProperty(value = "是否有效，0已删除，1有效",example = "1")
    private Integer valid;

    //不需要验证,新增时直接设置默认值
    @ApiModelProperty(value = "添加时间")
    private Date createTime;

    //不需要验证,新增时直接设置默认值,修改时使用java代码赋值
    @ApiModelProperty(value = "最后修改时间")
    private Date lastUpdateTime;
    
    private String brandName;
    
	private String categoryName;
}
```

om.baidu.shop.service：新建GoodsService

```java
package com.baidu.shop.service;

import com.baidu.shop.base.Result;
import com.baidu.shop.dto.SpuDto;
import com.baidu.shop.entity.SpuEntity;
import com.github.pagehelper.PageInfo;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import org.springframework.web.bind.annotation.GetMapping;

import java.util.List;

@Api(tags = "商品接口")
public interface GoodsService {
    @ApiOperation(value = "查询商品信息")
    @GetMapping(value = "goods/getSpuInfo")
    Result<PageInfo<SpuEntity>> getSpuInfo(SpuDto spuDto);
}
```

mingrui-shop-service-xxx

com.baidu.shop.mapper:新建SpuMapper

```
package com.baidu.shop.mapper;

import com.baidu.shop.entity.SpuEntity;
import tk.mybatis.mapper.common.Mapper;

public interface SpuMapper extends Mapper<SpuEntity> {
}
```

 修改CategoryMapper

```java
package com.baidu.shop.mapper;

import com.baidu.shop.entity.CategoryEntity;
import org.apache.ibatis.annotations.Select;
import tk.mybatis.mapper.additional.idlist.SelectByIdListMapper;
import tk.mybatis.mapper.common.Mapper;

import java.util.List;

/**
 * @ClassName CategoryMapper
 * @Description: TODO
 * @Author zhuyanlu
 * @Date 2020/12/22
 * @Version V1.0
 **/
public interface CategoryMapper extends Mapper<CategoryEntity> , SelectByIdListMapper<CategoryEntity,Integer> {

    //接口 + 实现类 + xml
    //接口 + xml
    //接口 + 注解(@Select + @Insert .....)
    @Select(value = "select id,name from tb_category where id in (select category_id from tb_category_brand where brand_id=#{brandId})")
    List<CategoryEntity> getCategoryByBrandId(Integer brandId);
}

```

com.baidu.shop.service.impl 新建GoodsServiceImpl

```
package com.baidu.shop.service.impl;

import com.baidu.shop.base.BaseApiService;
import com.baidu.shop.base.Result;
import com.baidu.shop.dto.SpuDTO;
import com.baidu.shop.entity.BrandEntity;
import com.baidu.shop.entity.CategoryEntity;
import com.baidu.shop.entity.SpuEntity;
import com.baidu.shop.mapper.BrandMapper;
import com.baidu.shop.mapper.CategoryMapper;
import com.baidu.shop.mapper.SpuMapper;
import com.baidu.shop.service.GoodsService;
import com.baidu.shop.status.HTTPStatus;
import com.baidu.shop.utils.BaiduBeanUtil;
import com.baidu.shop.utils.ObjectUtil;
import com.github.pagehelper.PageHelper;
import com.github.pagehelper.PageInfo;
import com.sun.org.apache.bcel.internal.generic.NEW;
import org.springframework.util.StringUtils;
import org.springframework.web.bind.annotation.RestController;
import tk.mybatis.mapper.entity.Example;

import javax.annotation.Resource;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.List;
import java.util.stream.Collectors;



/**
 * @ClassName GoodsServiceImpl
 * @Description: TODO
 * @Author zhuyanlu
 * @Date 2021/1/5
 * @Version V1.0 7
 **/
@RestController
public class GoodsServiceImpl extends BaseApiService implements GoodsService {

    @Resource
    private SpuMapper spuMapper;

    @Resource
    private BrandMapper brandMapper;

    @Resource
    private CategoryMapper categoryMapper;

    @Override
    public Result<List<SpuDTO>> getSpuInfo(SpuDTO spuDTO) {

        if(ObjectUtil.isNotNull(spuDTO.getPage()) && ObjectUtil.isNotNull(spuDTO.getRows()))
            PageHelper.startPage(spuDTO.getPage(),spuDTO.getRows());

        Example example = new Example(SpuEntity.class);
        Example.Criteria criteria = example.createCriteria();

        if(ObjectUtil.isNotNull(spuDTO.getSaleable()) && spuDTO.getSaleable() < 2)
            criteria.andEqualTo("saleable",spuDTO.getSaleable());
        if(!StringUtils.isEmpty(spuDTO.getTitle()))
            criteria.andLike("title","%" + spuDTO.getTitle() + "%");

        List<SpuEntity> spuEntities = spuMapper.selectByExample(example);

        List<SpuDTO> spuDTOList = spuEntities.stream().map(spuEntity -> {
            SpuDTO spuDTO1 = BaiduBeanUtil.copyProperties(spuEntity, SpuDTO.class);
            //通过分类id集合查询数据
            List<CategoryEntity> categoryEntities = categoryMapper.selectByIdList(Arrays.asList(spuEntity.getCid1(), spuEntity.getCid2(), spuEntity.getCid3()));
            // 遍历集合并且将分类名称用 / 拼接
            // 3/1/2
            //ajax --> 并不是所有情况都要用异步 jquery.validate 验证用户名存在不存在
            String categoryName = categoryEntities.stream().map(categoryEntity -> categoryEntity.getName()).collect(Collectors.joining("/"));
            spuDTO1.setCategoryName(categoryName);

            BrandEntity brandEntity = brandMapper.selectByPrimaryKey(spuEntity.getBrandId());
            spuDTO1.setBrandName(brandEntity.getName());
            return spuDTO1;
        }).collect(Collectors.toList());

        PageInfo<SpuEntity> spuEntityPageInfo = new PageInfo<>(spuEntities);
        // status , spuEntityPageInfo.getTotal + "" , spuDTOList
        //return this.setResultSuccess(spuEntityPageInfo);
        return this.setResult(HTTPStatus.OK,spuEntityPageInfo.getTotal() + "",spuDTOList);
    }
}
```

### 前台

Goods.vue

line：204

```
 getDataFromApi() {
        this.loading = true;
        //第三个参数可以设置axios参数
        //timeout:设置超时时间
        this.$http.get('goods/getSpuInfo',{
        //分页
          params: {
            page: this.pagination.page,
            rows: this.pagination.rowsPerPage,
            sort: this.pagination.sortBy,
            //上下架
            order: this.pagination.descending,
            //条件查询
            saleable:this.search.saleable,
            title:this.search.key
          }
        }).then((resp)=>{
            this.items = resp.data.data.list;
            this.totalItems = resp.data.data.total;
            this.loading = false;
        }).catch(error => console.log(error))
        // setTimeout(() => {
        //   // 返回假数据
        //   this.items = goodsData.slice(0, 4);
        //   this.totalItems = 25;
        //   this.loading = false;
        // }, 300)
      }
```

line:8

```
 <v-btn-toggle mandatory v-model="search.saleable">
          <v-btn flat :value="2">
            全部
          </v-btn>
          <v-btn flat :value="1">
            上架
          </v-btn>
          <v-btn flat :value="0">
            下架
          </v-btn>
        </v-btn-toggle>
```

**5 商品管理(新增[数据准备])**

**5.1 vue项目** 

**5.1.1 GoodsFrom.vue** 

5.1.1.1 line:20

5.1.1.2 line:277

5.1.1.3 line:57

5.1.1.4 line:206

```vue
<template>
  <v-stepper v-model="step">
    <v-stepper-header>
      <v-stepper-step :complete="step > 1" step="1">基本信息1</v-stepper-step>
      <v-divider/>
      <v-stepper-step :complete="step > 2" step="2">商品描述2</v-stepper-step>
      <v-divider/>
      <v-stepper-step :complete="step > 3" step="3">规格参数3</v-stepper-step>
      <v-divider/>
      <v-stepper-step step="4">SKU属性</v-stepper-step>
    </v-stepper-header>
    <v-stepper-items>
      <!--1、基本信息-->
      <v-stepper-content step="1">
        <v-flex class="xs10 mx-auto">
          <v-form v-model="valid" ref="basic">
            <v-layout row>
              <v-flex xs5>
                <!--商品分类-->
                <v-cascader
                  url="/category/list"
                  required
                  showAllLevels
                  v-model="goods.categories"
                  label="请选择商品分类"/>
              </v-flex>
              <v-spacer/>
              <v-flex xs5>
                <!--品牌-->
                <v-select
                  :items="brandOptions"
                  item-text="name"
                  item-value="id"
                  label="所属品牌"
                  v-model="goods.brandId"
                  required
                  autocomplete
                  clearable
                  dense chips
                  :rules="[v => !!v || '品牌不能为空']"
                >
                  <template slot="selection" slot-scope="data">
                    <v-chip small>{{ data.item.name}}</v-chip>
                  </template>
                </v-select>
              </v-flex>
            </v-layout>
            <v-text-field label="商品标题" v-model="goods.title" :counter="200" required :rules="[v => !!v || '商品标题不能为空']" hide-details/>
            <v-text-field label="商品卖点" v-model="goods.subTitle" :counter="200" hide-details/>
            <v-text-field label="包装清单" v-model="goods.spuDetail.packingList" :counter="1000" multi-line :rows="3" hide-details/>
            <v-text-field label="售后服务" v-model="goods.spuDetail.afterService" :counter="1000" multi-line :rows="3" hide-details/>
          </v-form>
        </v-flex>
      </v-stepper-content>
      <!--2、商品描述-->
      <v-stepper-content step="2">
        <v-editor v-model="goods.spuDetail.description" upload-url="/upload"/>
      </v-stepper-content>
      <!--3、规格参数-->
      <v-stepper-content step="3">
        <v-flex class="xs10 mx-auto px-3">
          <!--遍历整个规格参数-->
          <v-card class="my-2">
            <v-container grid-list-md fluid>
            <v-layout wrap row justify-space-between class="px-5">
              <v-flex xs12 sm5 v-for="param in specs" :key="param.name">
                <v-text-field :label="param.name" v-model="param.v" :suffix="param.unit || ''"
                 />
              </v-flex>
            </v-layout>
          </v-container>
          </v-card>
        </v-flex>
      </v-stepper-content>
      <!--4、SKU属性-->
      <v-stepper-content step="4">
        <v-flex class="mx-auto">
          <!--遍历特有规格参数-->
          <v-card flat v-for="spec in specialSpecs" :key="spec.name">
            <!--特有参数的标题-->
            <div class="subheading">{{spec.name}}:</div>
            <!--特有参数的待选项，需要判断是否有options，如果没有，展示文本框，让用户自己输入-->
            <v-card-text class="px-5">
              <div v-for="i in spec.options.length+1" :key="i" class="layout row px-5">
                <v-text-field :placeholder="'新的' + spec.name + ':'" class="flex xs10" auto-grow
                              v-model="spec.options[i-1]" v-bind:value="i" single-line hide-details/>

                <v-btn @click="spec.options.splice(i-1,1)" v-if="i <= spec.options.length" icon>
                  <i class="el-icon-delete"/>
                </v-btn>
              </div>
            </v-card-text>
          </v-card>
          <v-card class="elevation-0">
            <!--标题-->
            <div class="subheading py-3">SKU列表:</div>
            <v-divider/>
            <!--SKU表格，hide-actions因此分页等工具条-->
            <v-data-table :items="skus" :headers="headers" hide-actions item-key="indexes" class="elevation-0">
              <template slot="items" slot-scope="props">
                <tr @click="props.expanded = !props.expanded">
                  <!--价格和库存展示为文本框-->
                  <td v-for="(v,k) in props.item" :key="k" v-if="['price', 'stock'].includes(k)"
                      class="text-xs-center">
                    <v-text-field single-line v-model="props.item[k]" @click.stop=""/>
                  </td>
                  <!--enable展示为checkbox-->
                  <td class="text-xs-center" v-else-if="k === 'enable'">
                    <v-checkbox v-model="props.item[k]"/>
                  </td>
                  <!--indexes和images不展示，其它展示为普通文本-->
                  <td class="text-xs-center" v-else-if="k !== 'images' && k !== 'indexes'">{{v.v}}</td>
                </tr>
              </template>
              <!--点击表格后展开-->
              <template slot="expand" slot-scope="props">
                <v-card class="elevation-2 flex xs11 mx-auto my-2">
                  <!--图片上传组件-->
                  <v-upload v-model="props.item.images" url="/upload"/>
                </v-card>
              </template>
            </v-data-table>
          </v-card>
        </v-flex>
        <!--提交按钮-->
        <v-flex xs3 offset-xs9>
          <v-btn color="info" @click="submit">保存商品信息</v-btn>
        </v-flex>
      </v-stepper-content>
    </v-stepper-items>
  </v-stepper>
</template>

<script>
export default {
  name: "goods-form",
  props: {
    oldGoods: {
      type: Object
    },
    isEdit: {
      type: Boolean,
      default: false
    },
    step: {
      type: Number,
      default: 1
    }
  },
  data() {
    return {
      valid:false,
      goods: {
        categories: [], // 商品分类信息
        brandId: 0, // 品牌id信息
        title: "", // 标题
        subTitle: "", // 子标题
        spuDetail: {
          packingList: "", // 包装列表
          afterService: "", // 售后服务
          description: "" // 商品描述
        }
      },
      brandOptions: [], // 品牌列表
      specs: [], // 规格参数的模板
      specialSpecs: [] // 特有规格参数模板
    };
  },
  methods: {
    submit() {
      // 表单校验。
      if(!this.$refs.basic.validate){
        this.$message.error("请先完成表单内容！");
      }
      // 先处理goods，用结构表达式接收,除了categories外，都接收到goodsParams中
      const {
        categories: [{ id: cid1 }, { id: cid2 }, { id: cid3 }],
        ...goodsParams
      } = this.goods;
      // 处理规格参数
      const specs = {};
      this.specs.forEach(({ id,v }) => {
        specs[id] = v;
      });
      // 处理特有规格参数模板
      const specTemplate = {};
      this.specialSpecs.forEach(({ id, options }) => {
        specTemplate[id] = options;
      });
      // 处理sku

      console.log(this.skus)
      const skus = this.skus
        .filter(s => s.enable)
        .map(({ price, stock, enable, images, indexes, ...rest }) => {
          // 标题，在spu的title基础上，拼接特有规格属性值
          const title = goodsParams.title + " " + Object.values(rest).map(v => v.v).join(" ");
          const obj = {};
          Object.values(rest).forEach(v => {
            obj[v.id] = v.v;
          });
          return {
            price: this.$format(price), // 价格需要格式化
            stock,
            indexes,
            enable,
            title, // 基本属性
            //images: images ? images.join(",") : '', // 图片
            images: images ? images.map(image => image.data).join(",") : '',
            ownSpec: JSON.stringify(obj) // 特有规格参数
          };
        });
      Object.assign(goodsParams, {
        cid1,
        cid2,
        cid3, // 商品分类
        skus // sku列表
      });
      goodsParams.spuDetail.genericSpec = JSON.stringify(specs);
      goodsParams.spuDetail.specialSpec = JSON.stringify(specTemplate);

      //console.log(JSON.stringify(goodsParams))
      this.$http({
        method: this.isEdit ? "put" : "post",
        url: "/goods/save",
        data: goodsParams
      })
        .then(() => {
          // 成功，关闭窗口
          this.$emit("closeForm");
          // 提示成功
          this.$message.success("保存成功了");
        })
        .catch(() => {
          this.$message.error("保存失败！");
        });
    }
  },
  watch: {
    oldGoods: {
      deep: true,
      handler(val) {
        if (!this.isEdit) {
          Object.assign(this.goods, {
            categories: null, // 商品分类信息
            brandId: 0, // 品牌id信息
            title: "", // 标题
            subTitle: "", // 子标题
            spuDetail: {
              packingList: "", // 包装列表
              afterService: "", // 售后服务
              description: "" // 商品描述
            }
          });
          this.specs = [];
          this.specialSpecs = [];
        } else {
          this.goods = Object.deepCopy(val);

          // 先得到分类名称
          const names = val.cname.split("/");
          // 组织商品分类数据
          this.goods.categories = [
            { id: val.cid1, name: names[0] },
            { id: val.cid2, name: names[1] },
            { id: val.cid3, name: names[2] }
          ];

          // 将skus处理成map
          const skuMap = new Map();
          this.goods.skus.forEach(s => {
            skuMap.set(s.indexes, s);
          });
          this.goods.skus = skuMap;
        }
      }
    },
    "goods.categories": {
      deep: true,
      handler(val) {
        // 判断商品分类是否存在，存在才查询
        if (val && val.length > 0) {
          // 根据分类查询品牌
          this.$http
            .get("/brand/getBrandInfoByCategoryId",{
              params:{
                cid:this.goods.categories[2].id
              }
            })
            .then((resp) => {
              this.brandOptions = resp.data.data;
            });
          // 根据分类查询规格参数
          this.$http
            .get("/specparam/getSpecParamInfo",{
              params:{
                cid:this.goods.categories[2].id
              }
            })
            .then((resp) => {
              let specs = [];
              let template = [];
              if (this.isEdit){
                specs = JSON.parse(this.goods.spuDetail.genericSpec);
                template = JSON.parse(this.goods.spuDetail.specialSpec);
              }
              // 对特有规格进行筛选
              const arr1 = [];
              const arr2 = [];
              resp.data.data.forEach(({id, name,generic, numeric, unit }) => {
                if(generic){
                  const o = { id, name, numeric, unit};
                  if(this.isEdit){
                    o.v = specs[id];
                  }
                  arr1.push(o)
                }else{
                  const o = {id, name, options:[]};
                  if(this.isEdit){
                    o.options = template[id];
                  }
                  arr2.push(o)
                }
              });
              this.specs = arr1;// 通用规格
              this.specialSpecs = arr2;// 特有规格
            });
        }
      }
    }
  },
  computed: {
    skus() {
      // 过滤掉用户没有填写数据的规格参数
      const arr = this.specialSpecs.filter(s => s.options.length > 0);
      // 通过reduce进行累加笛卡尔积
      return arr.reduce(
        (last, spec, index) => {
          const result = [];
          last.forEach(o => {
            spec.options.forEach((option, i) => {
              const obj = JSON.parse(JSON.stringify(o));
              obj[spec.name] = {v:option, id:spec.id};
              obj.indexes = (obj.indexes || '') + '_' +  i
              if (index === arr.length - 1) {
                obj.indexes = obj.indexes.substring(1);
                // 如果发现是最后一组，则添加价格、库存等字段
                Object.assign(obj, {
                  price: 0,
                  stock: 0,
                  enable: false,
                  images: []
                });
                if (this.isEdit) {
                  // 如果是编辑，则回填sku信息
                  const sku = this.goods.skus.get(obj.indexes);
                  if (sku != null) {
                    const { price, stock, enable, images } = sku;
                    Object.assign(obj, {
                      price: this.$format(price),
                      stock,
                      enable,
                      images: images ? images.split(",") : [],
                    });
                  }
                }
              }
              result.push(obj);
            });
          });
          return result;
        },
        [{}]
      );
    },
    headers() {
      if (this.skus.length <= 0) {
        return [];
      }
      const headers = [];
      Object.keys(this.skus[0]).forEach(k => {
        let value = k;
        if (k === "price") {
          // enable，表头要翻译成“价格”
          k = "价格";
        } else if (k === "stock") {
          // enable，表头要翻译成“库存”
          k = "库存";
        } else if (k === "enable") {
          // enable，表头要翻译成“是否启用”
          k = "是否启用";
        } else if (k === "images" || k === 'indexes') {
          // 图片和索引不在表格中展示
          return;
        }
        headers.push({
          text: k,
          align: "center",
          sortable: false,
          value
        });
      });
      return headers;
    }
  }
};
</script>

<style scoped>
</style>


```

**5.1.2 Editor.vue**

5.1.3.1 line:93

```
this.$http.post(this.uploadUrl, data)
	.then(resp => {
        //修改图片回显的路径
        if (resp.data.data) {
			this.editor.insertEmbed(this.editor.getSelection().index, 'image',
resp.data.data)
	}
})

```

**5.2 mingrui-shop-service-api-xxx** 

**5.2.1 BrandService**

```java
@ApiOperation(value="通过分类id获取品牌")
@GetMapping(value = "brand/getBrandByCategory")
public Result<List<BrandEntity>> getBrandByCategory(Integer cid);
```

**5.3 mingrui-shop-service-xxx**

 **5.3.1 BrandMapper**

```java
package com.baidu.shop.mapper;

import com.baidu.shop.entity.BrandEntity;
import org.apache.ibatis.annotations.Select;
import tk.mybatis.mapper.common.Mapper;

import java.util.List;

/**
 * @ClassName BrandMapper
 * @Description: TODO
 * @Author shenyaqi
 * @Date 2020/12/25
 * @Version V1.0
 **/
public interface BrandMapper extends Mapper<BrandEntity> {

    @Select(value = "select * from tb_brand b where b.id in(select cb.brand_id from tb_category_brand cb where cb.category_id=#{cid})")
    List<BrandEntity> getBrandInfoByCategoryId(Integer cid);
}

```

**5.3.1 BrandServiceImpl**

```java
@Override
public Result<BrandEntity> getBrandByCategory(Integer cid) {

		if(ObjectUtil.isNotNull(cid)){
		
			List<BrandEntity> list = brandMapper.getBrandByCategory(cid);
			
			return this.setResultSuccess(list);
	}
	return null;
}

```

**5.3.2 SpecificationServiceImpl**

```java
//通过条件查询规格参数
    @Override
    @Transactional
    public Result<List<SpecParamEntity>> getSpecParamInfo(SpecParamDTO specParamDTO) {

        SpecParamEntity specParamEntity = BaiduBeanUtil.copyProperties(specParamDTO, SpecParamEntity.class);
        Example example = new Example(SpecParamEntity.class);
        Example.Criteria criteria = example.createCriteria();

        if(ObjectUtil.isNotNull(specParamEntity.getGroupId()))
            criteria.andEqualTo("groupId",specParamEntity.getGroupId());
        if(ObjectUtil.isNotNull(specParamEntity.getCid()))
            criteria.andEqualTo("cid",specParamEntity.getCid());

        List<SpecParamEntity> specParamEntities = specParamMapper.selectByExample(example);

        return this.setResultSuccess(specParamEntities);
    }
```

**6 商品管理(新增[传值接值])**

**6.1 mingrui-shop-service-api-xxx**

 **6.1.1 entity包下实体类**

 **6.1.1.1 SpuDetailEntity**

```java
package com.baidu.shop.entity;

import lombok.Data;

import javax.persistence.Id;
import javax.persistence.Table;

/**
 * @ClassName SpuDetailEntity
 * @Description: TODO
 * @Author zhuyanlu
 * @Date 2021/1/7
 * @Version V1.0 7
 **/
@Table(name = "tb_spu_detail")
@Data
public class SpuDetailEntity {

    @Id
    private Integer spuId;

    private String description;

    private String genericSpec;

    private String specialSpec;

    private String packingList;

    private String afterService;
}

```

**6.1.1.2 SkuEntity**

```java
package com.baidu.shop.entity;

import lombok.Data;

import javax.persistence.GeneratedValue;
import javax.persistence.GenerationType;
import javax.persistence.Id;
import javax.persistence.Table;
import java.util.Date;

/**
 * @ClassName SkuEntity
 * @Description: TODO
 * @Author zhuyanlu
 * @Date 2021/1/7
 * @Version V1.0 7
 **/
@Table(name = "tb_sku")
@Data
public class SkuEntity {

    @Id//此处必须写long类型,因为现在新增的id已经超过int的范围了
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    private Integer spuId;

    private String title;

    private String images;

    private Integer price;

    private String indexes;

    private String ownSpec;

    private Integer enable;

    private Date createTime;

    private Date lastUpdateTime;
}

```

**6.1.1.3 StockEntity**

```java
package com.baidu.shop.entity;

import io.swagger.models.auth.In;
import lombok.Data;

import javax.persistence.Id;
import javax.persistence.Table;

/**
 * @ClassName StockEntity
 * @Description: TODO
 * @Author zhuyanlu
 * @Date 2021/1/7
 * @Version V1.0 7
 **/
@Table(name = "tb_stock")
@Data
public class StockEntity {

    @Id
    private Long skuId;

    private Integer seckillStock;

    private Integer seckillTotal;

    private Integer stock;
}

```

**6.1.2 dto包下新建dto** 

**6.1.2.1 SpuDetailDTO**

```java
package com.baidu.shop.dto;

import io.swagger.annotations.ApiModel;
import io.swagger.annotations.ApiModelProperty;
import lombok.Data;

/**
 * @ClassName SpuDetailDTO
 * @Description: TODO
 * @Author zhuyanlu
 * @Date 2021/1/7
 * @Version V1.0 7
 **/
@ApiModel(value = "spu大字段数据传输类")
@Data
public class SpuDetailDTO {

    @ApiModelProperty(value = "spu主键",example = "1")
    private Integer spuId;

    @ApiModelProperty(value = "商品描述信息")
    private String description;

    @ApiModelProperty(value = "通用规格参数数据")
    private String genericSpec;

    @ApiModelProperty(value = "特有规格参数及可选值信息，json格式")
    private String specialSpec;

    @ApiModelProperty(value = "包装清单")
    private String packingList;

    @ApiModelProperty(value = "售后服务")
    private String afterService;

}

```

**6.1.2.2 SkuDTO**

```java
package com.baidu.shop.dto;

import io.swagger.annotations.ApiModel;
import io.swagger.annotations.ApiModelProperty;
import lombok.Data;

import java.util.Date;
/**
 * @ClassName SkuDTO
 * @Description: TODO
 * @Author zhuyanlu
 * @Date 2021/1/7
 * @Version V1.0 7
 **/
@ApiModel(value = "SKU属性数据传输类")
@Data
public class SkuDTO {

    @ApiModelProperty(value = "主键", example = "1")
    private Long id;

    @ApiModelProperty(value = "spu主键", example = "1")
    private Integer spuId;

    @ApiModelProperty(value = "商品标题")
    private String title;

    @ApiModelProperty(value = "商品的图片，多个图片以‘,’分割")
    private String images;

    @ApiModelProperty(value = "销售价格，单位为分", example = "1")
    private Integer price;

    @ApiModelProperty(value = "特有规格属性在spu属性模板中的对应下标组合")
    private String indexes;

    @ApiModelProperty(value = "sku的特有规格参数键值对，json格式，反序列化时请使用linkedHashMap，保证有序")
    private String ownSpec;

    //注意此处使用boolean值来接,在service中处理一下就可以了
    @ApiModelProperty(value = "是否有效，0无效，1有效", example = "1")
    private Boolean enable;

    @ApiModelProperty(value = "添加时间")
    private Date createTime;

    @ApiModelProperty(value = "最后修改时间")
    private Date lastUpdateTime;

    //方便接受页面传递过来的参数
    @ApiModelProperty(value = "库存")
    private Integer stock;


}

```

**6.1.2.3 StockDTO**

```java
package com.baidu.shop.dto;

import io.swagger.annotations.ApiModel;
import io.swagger.annotations.ApiModelProperty;
import lombok.Data;

/**
 * @ClassName StockDTO
 * @Description: TODO
 * @Author zhuyanlu
 * @Date 2021/1/7
 * @Version V1.0 7
 **/
@ApiModel(value = "库存数据传输类")
@Data
public class StockDTO {

    @ApiModelProperty(value = "sku主键", example = "1")
    private Long skuId;

    @ApiModelProperty(value = "可秒杀库存", example = "1")
    private Integer seckillStock;

    @ApiModelProperty(value = "秒杀总数量", example = "1")
    private Integer seckillTotal;

    @ApiModelProperty(value = "库存数量", example = "1")
    private Integer stock;
}

```

**6.1.3 修改SpuDTO**

```java
package com.baidu.shop.dto;

import com.baidu.shop.base.BaseDTO;
import com.baidu.shop.validate.group.MingruiOperation;
import io.swagger.annotations.ApiModel;
import io.swagger.annotations.ApiModelProperty;
import lombok.Data;

import javax.validation.constraints.NotEmpty;
import javax.validation.constraints.NotNull;
import java.util.Date;
import java.util.List;

/**
 * @ClassName SpuDTO
 * @Description: TODO
 * @Author zhuyanlu
 * @Date 2021/1/5
 * @Version V1.0 7
 **/
@ApiModel(value = "spu数据传输DTO")
@Data
public class SpuDTO extends BaseDTO {

    @ApiModelProperty(value = "主键", example = "1")
    @NotNull(message = "主键不能为空", groups = {MingruiOperation.Update.class})
    private Integer id;

    @ApiModelProperty(value = "标题")
    @NotEmpty(message = "标题不能为空", groups = {MingruiOperation.Add.class})
    private String title;

    @ApiModelProperty(value = "子标题")
    private String subTitle;

    @ApiModelProperty(value = "1级类目id", example = "1")
    @NotNull(message = "1级类目id不能为空",groups = {MingruiOperation.Add.class})
    private Integer cid1;

    @ApiModelProperty(value = "2级类目id", example = "1")
    @NotNull(message = "2级类目id不能为空",groups = {MingruiOperation.Add.class})
    private Integer cid2;

    @ApiModelProperty(value = "3级类目id", example = "1")
    @NotNull(message = "3级类目id不能为空",groups = {MingruiOperation.Add.class})
    private Integer cid3;

    @ApiModelProperty(value = "商品所属品牌id", example = "1")
    @NotNull(message = "商品所属品牌id不能为空",groups = {MingruiOperation.Add.class})
    private Integer brandId;

    //不需要验证,新增时直接设置默认值
    @ApiModelProperty(value = "是否上架，0下架，1上架", example = "1")
    private Integer saleable;

    //不需要验证,新增时直接设置默认值
    @ApiModelProperty(value = "是否有效，0已删除，1有效", example = "1")
    private Integer valid;

    //不需要验证,新增时直接设置默认值
    @ApiModelProperty(value = "添加时间")
    private Date createTime;

    //不需要验证,新增时直接设置默认值,修改时使用java代码赋值
    @ApiModelProperty(value = "最后修改时间")
    private Date lastUpdateTime;

    private String categoryName;

    private String brandName;

    @ApiModelProperty(value = "大字段数据")
    private SpuDetailDTO spuDetail;

    @ApiModelProperty(value = "sku属性数据集合")
    private List<SkuDTO> skus;
}

```

**6.1.4 GoodsService**

```java
 @ApiOperation(value = "新增商品")
    @PostMapping(value = "/goods/save")
    Result<JSONObject> saveGoods(@RequestBody SpuDTO spuDTO);
```

**6.2 GoodsServiceImpl**

```java
@Override
public Result<JSONObject> saveGoods(SpuDTO spuDTO) {

    System.out.println(spuDTO);
    return this.setResultSuccess();
}

```

**能正常接收到所有页面数据即可**

**7 商品管理(新增[入库])** 

**7.1 vue项目**

 **7.1.1 GoodsForm.vue line:277**

```vue
 		// 成功，关闭窗口
          this.$emit("closeForm");//bug.....
```

**7.2 mingrui-shop-service-xxx** 

**7.2.1 mapper包下新建mapper** 

**7.2.1.1 SpuDetailMapper**

```java
package com.baidu.shop.mapper;

import com.baidu.shop.entity.SpuDetailEntity;
import tk.mybatis.mapper.common.Mapper;

/**
 * @ClassName SpuDetailMapper
 * @Description: TODO
 * @Author zhuyanlu
 * @Date 2021/1/7
 * @Version V1.0 7
 **/
public interface SpuDetailMapper extends Mapper<SpuDetailEntity> {
}

```

**7.2.1.2 SkuMapper**

```java
package com.baidu.shop.mapper;

import com.baidu.shop.entity.SkuEntity;
import tk.mybatis.mapper.common.Mapper;
import tk.mybatis.mapper.common.special.InsertListMapper;

/**
 * @ClassName SkuMapper
 * @Description: TODO
 * @Author zhuyanlu
 * @Date 2021/1/7
 * @Version V1.0 7
 **/
public interface SkuMapper extends Mapper<SkuEntity>, InsertListMapper<SkuEntity> {
}

```

**7.2.1.3 StockMapper**

```java
package com.baidu.shop.mapper;

import com.baidu.shop.entity.StockEntity;
import tk.mybatis.mapper.common.Mapper;

/**
 * @ClassName StockMapper
 * @Description: TODO
 * @Author zhuyanlu
 * @Date 2021/1/7
 * @Version V1.0 7
 **/
public interface StockMapper extends Mapper<StockEntity> {
}

```

**7.2.2 GoodsServiceImpl**

```java
	@Resource
    private CategoryMapper categoryMapper;

    @Resource
    private SpuDetailMapper spuDetailMapper;

    @Resource
    private SkuMapper skuMapper;

    @Resource
    private StockMapper stockMapper;
    
    
     //商品新增
    @Override
    @Transactional
    public Result<JSONObject> saveGoods(SpuDTO spuDTO) {
       
        final Date date = new Date();//保持两个时间一致
        //新增spu,新增返回主键, 给必要字段赋默认值
        SpuEntity spuEntity = BaiduBeanUtil.copyProperties(spuDTO, SpuEntity.class);
        spuEntity.setSaleable(1);
        spuEntity.setValid(1);
        spuEntity.setCreateTime(date);
        spuEntity.setLastUpdateTime(date);
        spuMapper.insertSelective(spuEntity);

        //新增spuDetail
        SpuDetailDTO spuDetail = spuDTO.getSpuDetail();
        SpuDetailEntity spuDetailEntity = BaiduBeanUtil.copyProperties(spuDetail, SpuDetailEntity.class);
        spuDetailEntity.setSpuId(spuEntity.getId());
        spuDetailMapper.insertSelective(spuDetailEntity);

        //新增sku list插入顺序有序 b,a set a,b treeSet b,a
        List<SkuDTO> skus = spuDTO.getSkus();
        skus.stream().forEach(skuDTO -> {

            SkuEntity skuEntity = BaiduBeanUtil.copyProperties(skuDTO, SkuEntity.class);
            skuEntity.setSpuId(spuEntity.getId());
            skuEntity.setCreateTime(date);
            skuEntity.setLastUpdateTime(date);
            skuMapper.insertSelective(skuEntity);

            //新增stock
            StockEntity stockEntity = new StockEntity();
            stockEntity.setSkuId(skuEntity.getId());
            stockEntity.setStock(skuDTO.getStock());
            stockMapper.insertSelective(stockEntity);
        });

        return this.setResultSuccess();
    }
```

**8 修改(回显数据)**

 **8.1 vue项目**

注意:源码中bug太多.....

 将editItem函数中的内容全部删除掉 

editItem函数中需要将spuDetail和skus全部查询出来再赋值给this.selectedGoods赋值

 demo中的回显只能回显spu的相关信息

 spuDetail和sku stock需要我们自己从数据库中查询

**8.1.1 Goods.vue**

```js
editItem(item) {
        //this.selectedGoods = item;
    
	//不能直接给this.selectedGoods赋值,在这赋值以后GoodsForm会监控到oldGoods发生变化
    
        // const names = item.categoryName.split("/");
        // this.selectedGoods.categories = [
        //   {id: item.cid1, name: names[0]},
        //   {id: item.cid2, name: names[1]},
        //   {id: item.cid3, name: names[2]}
        // ];
        // 查询商品详情
        //保证isEdit状态为true
    //弹出模态框,页面bug,理论上不应该这么做
        this.isEdit = true;
        this.show = true;

        //只监控一次oldGoods
        let obj = item;//列表中传输过来的数据
    //查询商品详情
        this.$http.get("/goods/getSpuDetailBySpuId",{
          params:{
            spuId:item.id
          }
        }).then(resp => {
            //准备分类需要回显的数据
          obj.categories = [];//解决监控到的值为undefined
            //商品详情
          obj.spuDetail = resp.data.data;
            //特殊规格数据
          obj.spuDetail.specTemplate = JSON.parse(resp.data.data.specialSpec);//特有规格参数
            //通过规格数据
          obj.spuDetail.specifications = JSON.parse(resp.data.data.genericSpec);//通用规格参数

            // this.selectedGoods.spuDetail = resp.data.data;
            // this.selectedGoods.spuDetail.specTemplate = JSON.parse(resp.data.data.specialSpec);//特有规格参数
            // this.selectedGoods.spuDetail.specifications = JSON.parse(resp.data.data.genericSpec);//通用规格参数
            //通过spuId查询skus
            this.$http.get('/goods/getSkusBySpuId',{
              params:{
                spuId:item.id
              }
            }).then(resp => {
              obj.skus = resp.data.data;
                //需要回显的数据
              this.selectedGoods = obj;//最后再给selectedGoods赋值
            }).catch(error => console.log(error));

        })
        
      },
```

**8.1.2 GoodsForm.vue**

```js
//监控需要回显的数据 
oldGoods: {
      deep: true,
      handler(val) {
          //新增,清空数据
        if (!this.isEdit) {
          Object.assign(this.goods, {
            categories: null, // 商品分类信息
            brandId: 0, // 品牌id信息
            title: "", // 标题
            subTitle: "", // 子标题
            spuDetail: {
              packingList: "", // 包装列表
              afterService: "", // 售后服务
              description: "" // 商品描述
            }
          });
          this.specs = [];
          this.specialSpecs = [];
        } else {//修改
           //深拷贝?????深拷贝与浅拷贝的区别
          this.goods = Object.deepCopy(val);

          // 先得到分类名称 bug!!!!
          window.setTimeout(() => {
              // 先得到分类名称 bug我们获取到的是categoryName
            const names = val.categoryName.split("/");
            // 组织商品分类数据
            this.goods.categories = [
              { id: val.cid1, name: names[0] },
              { id: val.cid2, name: names[1] },
              { id: val.cid3, name: names[2] }
            ];
          },30)


          // 将skus处理成map
          const skuMap = new Map();
          this.goods.skus.forEach(s => {
            skuMap.set(s.indexes, s);
          });
          this.goods.skus = skuMap;
        }
      }
    },
    "goods.categories": {
      deep: true,
      handler(val) {
        console.log(val)
        // 判断商品分类是否存在，存在才查询
        if (val && val.length > 0) {
          // 根据分类查询品牌
          this.$http
            .get("/brand/getBrandInfoByCategoryId",{
              params:{
                cid:this.goods.categories[2].id
              }
            })
            .then((resp) => {
              this.brandOptions = resp.data.data;
            });
          // 根据分类查询规格参数
          this.$http
            .get("/specparam/getSpecParamInfo",{
              params:{
                cid:this.goods.categories[2].id
              }
            })
            .then((resp) => {
              let specs = [];
              let template = [];
              if (this.isEdit){
                specs = JSON.parse(this.goods.spuDetail.genericSpec);
                template = JSON.parse(this.goods.spuDetail.specialSpec);
              }
              // 对特有规格进行筛选
              const arr1 = [];
              const arr2 = [];
              resp.data.data.forEach(({id, name,generic, numeric, unit }) => {
                if(generic){
                  const o = { id, name, numeric, unit};
                  if(this.isEdit){
                    o.v = specs[id];
                  }
                  arr1.push(o)
                }else{
                  const o = {id, name, options:[]};
                  if(this.isEdit){
                    o.options = template[id];
                  }
                  arr2.push(o)
                }
              });
              this.specs = arr1;// 通用规格
              this.specialSpecs = arr2;// 特有规格
            });
        }
      }
    }
  },
```

**8.2 mingrui-shop-service-api-xxx** 

**8.2.1 GoodsService**

```java
	@ApiOperation(value = "通过spuId查询spudetail信息")
    @GetMapping(value = "/goods/getSpuDetailBySpuId")
    Result<SpuDetailEntity> getSpuDetailBySpuId(Integer spuId);

    @ApiOperation(value = "通过spuId查询sku信息")
    @GetMapping(value = "/goods/getSkusBySpuId")
    Result<List<SkuDTO>> getSkusBySpuId(Integer spuId);
```

**8.3 mingrui-shop-service-xxx**

 **8.3.1 SkuMapper**

```java
package com.baidu.shop.mapper;

import com.baidu.shop.dto.SkuDTO;
import com.baidu.shop.entity.SkuEntity;
import org.apache.ibatis.annotations.Select;
import tk.mybatis.mapper.additional.idlist.DeleteByIdListMapper;
import tk.mybatis.mapper.common.Mapper;
import tk.mybatis.mapper.common.special.InsertListMapper;

import java.util.List;

/**
 * @ClassName SkuMapper
 * @Description: TODO
 * @Author zhuyanlu
 * @Date 2021/1/7
 * @Version V1.0 7
 **/
public interface SkuMapper extends Mapper<SkuEntity>, InsertListMapper<SkuEntity>  {

    @Select(value = "select k.*,t.stock from tb_sku k, tb_stock t where k.id = t.sku_id and k.spu_id = #{spuId}")
    List<SkuDTO> getSkusAndStockBySpuId(Integer spuId);
}

```

**8.3.2 GoodsServiceImpl**

```java
//通过spuId查询spudetail信息
    @Override
    @Transactional
    public Result<SpuDetailEntity> getSpuDetailBySpuId(Integer spuId) {

        SpuDetailEntity spuDetailEntity = spuDetailMapper.selectByPrimaryKey(spuId);
        return this.setResultSuccess(spuDetailEntity);
    }

    //通过spuId查询sku信息
    @Override
    @Transactional
    public Result<List<SkuDTO>> getSkusBySpuId(Integer spuId) {

        List<SkuDTO> list = skuMapper.getSkusAndStockBySpuId(spuId);
        return this.setResultSuccess(list);
    }

```

**9 修改(后台)** 

**9.1 vue项目** 

**9.1.1 GoodsForm.vue**

```js
 this.$http({
        method: this.isEdit ? "put" : "post",
        url: "/goods/save",
        data: goodsParams
      })
```

**9.2 mingrui-shop-service-api-xxx**

 **9.2.1 GoodsService**

```java
 	@ApiOperation(value = "新增商品")
    @PostMapping(value = "/goods/save")
    Result<JSONObject> saveGoods(@RequestBody SpuDTO spuDTO);

    @ApiOperation(value = "修改商品")
    @PutMapping(value = "/goods/save")
    Result<JSONObject> editGoods(@RequestBody SpuDTO spuDTO);
```

**9.3 mingrui-shop-service-xxx**

**9.3.1 修改的步骤** 

1. 修改spu 
2. 修改spuDetail 
3. 通过spuId查询出来将要被删除的sku
4. 获取所有将要被删除skuId(如果直接删除的话stock没有办法删除) 
5. 批量删除sku 
6. 批量删除stock 
7. 将新的数据新增到数据库

**9.3.2 修改SkuMapper和StockMapper** 

**9.3.2.1 SkuMapper**

```java
package com.baidu.shop.mapper;

import com.baidu.shop.dto.SkuDTO;
import com.baidu.shop.entity.SkuEntity;
import org.apache.ibatis.annotations.Select;
import tk.mybatis.mapper.additional.idlist.DeleteByIdListMapper;
import tk.mybatis.mapper.common.Mapper;
import tk.mybatis.mapper.common.special.InsertListMapper;

import java.util.List;

/**
 * @ClassName SkuMapper
 * @Description: TODO
 * @Author zhuyanlu
 * @Date 2021/1/7
 * @Version V1.0 7
 **/
public interface SkuMapper extends Mapper<SkuEntity>, InsertListMapper<SkuEntity> , DeleteByIdListMapper<SkuEntity,Long> {

    @Select(value = "select k.*,t.stock from tb_sku k, tb_stock t where k.id = t.sku_id and k.spu_id = #{spuId}")
    List<SkuDTO> getSkusAndStockBySpuId(Integer spuId);
}

```

**9.3.2.2 StockMapper**

```java
package com.baidu.shop.mapper;

import com.baidu.shop.entity.StockEntity;
import tk.mybatis.mapper.additional.idlist.DeleteByIdListMapper;
import tk.mybatis.mapper.common.Mapper;

/**
 * @ClassName StockMapper
 * @Description: TODO
 * @Author zhuyanlu
 * @Date 2021/1/7
 * @Version V1.0 7
 **/
public interface StockMapper extends Mapper<StockEntity>, DeleteByIdListMapper<StockEntity,Long> {
}

```

**9.3.3 GoodsServiceImpl**

```java
//修改
    @Override
    @Transactional
    public Result<JSONObject> editGoods(SpuDTO spuDTO) {

        final Date date = new Date();
        //修改spu
        SpuEntity spuEntity = BaiduBeanUtil.copyProperties(spuDTO,SpuEntity.class);
        spuEntity.setLastUpdateTime(date);
        spuMapper.updateByPrimaryKeySelective(spuEntity);

        //修改spuDetail
        spuDetailMapper.updateByPrimaryKeySelective(BaiduBeanUtil.copyProperties(spuDTO.getSpuDetail(),SpuDetailEntity.class));


        //通过spuId查询sku信息
        this.deleteSkusAndStock(spuEntity.getId());

        this.saveSkusAndStockInfo(spuDTO,spuEntity.getId(),date);

        return this.setResultSuccess();
    }
    
    //与新增的部分代码重复,所以将重复代码抽取出来,记得修改新增方法!!!
     //商品新增
    @Override
    @Transactional
    public Result<JSONObject> saveGoods(SpuDTO spuDTO) {
        //final finally finalize()的区别????
        final Date date = new Date();//保持两个时间一致
        //新增spu,新增返回主键, 给必要字段赋默认值
        SpuEntity spuEntity = BaiduBeanUtil.copyProperties(spuDTO, SpuEntity.class);
        spuEntity.setSaleable(1);
        spuEntity.setValid(1);
        spuEntity.setCreateTime(date);
        spuEntity.setLastUpdateTime(date);
        spuMapper.insertSelective(spuEntity);

        //新增spuDetail
        SpuDetailDTO spuDetail = spuDTO.getSpuDetail();
        SpuDetailEntity spuDetailEntity = BaiduBeanUtil.copyProperties(spuDetail, SpuDetailEntity.class);
        spuDetailEntity.setSpuId(spuEntity.getId());
        spuDetailMapper.insertSelective(spuDetailEntity);

        //新增sku list插入顺序有序 b,a set a,b treeSet b,a
        List<SkuDTO> skus = spuDTO.getSkus();
        skus.stream().forEach(skuDTO -> {

            SkuEntity skuEntity = BaiduBeanUtil.copyProperties(skuDTO, SkuEntity.class);
            skuEntity.setSpuId(spuEntity.getId());
            skuEntity.setCreateTime(date);
            skuEntity.setLastUpdateTime(date);
            skuMapper.insertSelective(skuEntity);

            //新增stock
            StockEntity stockEntity = new StockEntity();
            stockEntity.setSkuId(skuEntity.getId());
            stockEntity.setStock(skuDTO.getStock());
            stockMapper.insertSelective(stockEntity);
        });

        return this.setResultSuccess();
    }
```

**10 删除** 

**10.1 vue项目**

 **10.1.1 Goods.vue**

```js
  deleteItem(id) {
        this.$message.confirm('此操作将永久删除该商品, 是否继续?')
          .then(() => {
            // 发起删除请求
            this.$http.delete("/goods/delete?spuId=" + id)
              .then(() => {
                // 删除成功，重新加载数据
                this.getDataFromApi();
                this.$message.info('删除成功!');
              })
          })
          .catch(() => {
            this.$message.info('已取消删除');
          });

      },
```

1**0.2 mingrui-shop-service-api-xxx** 

**10.2.1 GoodsService**

```java
	@ApiOperation(value = "删除商品")
    @DeleteMapping(value = "/goods/delete")
    Result<JSONObject> deleteGoods(Integer spuId);
```

**10.3 mingrui-shop-service-xxx** 

**10.3.1 GoodsServiceImpl**

```java
 //删除
    @Override
    @Transactional
    public Result<JSONObject> deleteGoods(Integer spuId) {

        //删除spu
        spuMapper.deleteByPrimaryKey(spuId);
        //删除spuDetail
        spuDetailMapper.deleteByPrimaryKey(spuId);
        //删除sku 和 stock
        //通过spuId查询sku信息
        this.deleteSkusAndStock(spuId);

        return this.setResultSuccess();
    }
    
    
    //重复代码抽取出来
     private void deleteSkusAndStock(Integer spuId){
        Example example = new Example(SkuEntity.class);
        example.createCriteria().andEqualTo("spuId",spuId);
        List<SkuEntity> skuEntities = skuMapper.selectByExample(example);
        //得到skuId集合
        List<Long> skuIdList = skuEntities.stream().map(skuEntity -> skuEntity.getId()).collect(Collectors.toList());
        skuMapper.deleteByIdList(skuIdList);//通过skuId集合删除sku信息
        stockMapper.deleteByIdList(skuIdList);//通过skuId集合删除stock信息
    }

```

**11商品上下架**

**11.1 vue项目**

 **11.1.1 Goods.vue**

line:54,55

```js
<v-btn icon small v-if="props.item.saleable" @click="sxj(props.item)">下架</v-btn>
<v-btn icon v-else @click="sxj(props.item)">上架</v-btn>
```

```js
 sxj(val){
        val.saleable = val.saleable?0:1
        this.$message.confirm('确定下架当前商品吗?,是否继续')
        .then(( )=> {
          //发起删除请求
          this.$http.put("/goods/sxjGoods",val)
          .then(() =>{
            //删除成功 重新加载数据
            this.getDataFromApi();
            this.$message.success('下架成功!');
          })
        })
        .catch(() => {
          this.$message.error('已取消删除');
        })
      },
```

**11.1.2GoodsService.java**

```java
 //上下架
    @ApiOperation(value="上下架商品")
    @PutMapping(value = "goods/sxjGoods")
    Result<JSONObject> sxjGoods(@RequestBody SpuDTO spuDTO);
```

**11.1.3GoodsServiceImpl.java**

```java
//上下架
    @Override
    @Transactional
    public Result<JSONObject> sxjGoods(SpuDTO spuDTO) {
        SpuEntity spuEntity = BaiduBeanUtil.copyProperties(spuDTO,SpuEntity.class);
        spuMapper.updateByPrimaryKeySelective(spuEntity);
        return this.setResultSuccess();
    }
```

