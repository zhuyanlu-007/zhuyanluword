# 1.概述

nginx进行反向代理

实现商品分类CRUD功能

cors解决跨域

# 2.域名访问本地项目

## 2.1解决域名解析问题

Windows下的hosts文件地址：C:/Windows/System32/drivers/etc/hosts

Linux下的hosts文件所在路径： /etc/hosts

修改本地的host为：

> 127.0.0.1 api.mrshop.com   //网关zull
>
> 127.0.0.1 manage.mrshop.com  //后台系统地址

ping一下域名试试是否畅通

## 2.2测试项目

启动后端vue项目:

将项目压缩包解压,使用vscode打开项目

dev编译项目.

输入域名 + 9001端口号出现以下错误

![image-20210105144205079](C:\Users\MyComputer\AppData\Roaming\Typora\typora-user-images\image-20210105144205079.png)

打开build文件夹下webpack.dev.conf.js文件     在devServer下加入

```
disableHostCheck: true,
```

再次编译项目,进行访问 manage.shop.com:9001

## 2.3nginx安装和使用

我们希望的是直接域名访问： http://manage.mrshop.com 。这种情况下端口默认是80，需要使用反向代理工具Nginx将请求转移到9001端口

### 什么是反向代理？

​	代理：通过客户机的配置，实现让一台服务器代理客户机，客户的所有请求都交给代理服务器处理。

​	反向代理：用一台服务器，代理真实服务器，用户访问时，不再是访问真实服务器，而是代理服务器。

nginx可以当做反向代理服务器来使用：

​	我们需要提前在nginx中配置好反向代理的规则，不同的请求，交给不同的真实服务器处理

​	当请求到达nginx，nginx会根据已经定义的规则进行请求的转发，从而实现路由功能

### 2.3.1安装nginx

解压nginx-1.16.1.zip

安装完成

### 2.3.2使用nginx

nginx可以通过命令行来启动，操作命令：

启动： 

```
start nginx.exe
```

停止： 

```
nginx.exe -s stop
```

重新加载： 

```
nginx.exe -s reload
```

反向代理配置

修改nginx/conf/nginx.conf文件



    worker_processes  1;
    
    events {
        worker_connections  1024;
    }
    
    http {
    
        include       mime.types;
        default_type  application/octet-stream;
    	
    	sendfile on; 
    	keepbaiduve_timeout 65;
    	
        server {
    	
            listen 80;
            server_name manage.mrshop.com;
    		
    		proxy_set_header X-Forwarded-Host $host;
    		proxy_set_header X-Forwarded-Server $host;
    		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    		
            location / {
                proxy_pass http://127.0.0.1:9001; 
    			proxy_connect_timeout 600; 
    			proxy_read_timeout 600;
            }
        }
    	
    	server { 
    	
    		listen 80; 
    		server_name api.mrshop.com; 
    		
    		proxy_set_header X-Forwarded-Host $host; 
    		proxy_set_header X-Forwarded-Server $host; 
    		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; 
    		
    	location / { 
    			proxy_pass http://127.0.0.1:8088; 
    			proxy_connect_timeout 600; 
    			proxy_read_timeout 600; 
    		}
    		
    	}
    }

### 2.3.3测试nginx

浏览器输入http://manage.mrshop.com/

出现以下效果即可

![image-20210105150114909](C:\Users\MyComputer\AppData\Roaming\Typora\typora-user-images\image-20210105150114909.png)

域名访问网站的流程是:

1. 浏览器准备发起请求，访问http://mamage.mrshop.com，但需要进行域名解析
2. 优先进行本地域名解析，因为我们修改了hosts，所以解析成功，得到地址：127.0.0.1
3. 请求被发往解析得到的ip，并且默认使用80端口：http://127.0.0.1:80  , 本机的nginx一直监听80端口，因此捕获这个请求
4. nginx中配置了反向代理规则，将manage.mrshop.com代理到127.0.0.1:9001，因此请求被转发
5. 后台系统的webpack server监听的端口是9001，得到请求并处理，完成后将响应返回到nginx
6. nginx将得到的结果返回到浏览器









# 3.商品分类管理-->查询 

## 3.1mingrui-shop-common-core工程

### 3.1.1在mingrui-shop--commons项目下新建mingrui-shop-commons-core项目

### 3.1.2 pom.xml

```
<!--处理json与各种数据类型或文档类型的转换-->
<dependency>
    <groupId>com.google.code.gson</groupId>
    <artifactId>gson</artifactId>
    <version>2.8.5</version>
</dependency>
<!--json对象序列化和反序列化的支持-->
<dependency>
    <groupId>org.codehaus.jackson</groupId>
    <artifactId>jackson-core-lgpl</artifactId>
    <version>1.9.13</version>
</dependency>
<dependency>
    <groupId>org.codehaus.jackson</groupId>
    <artifactId>jackson-mapper-lgpl</artifactId>
    <version>1.9.13</version>
</dependency>
<!--java对象和json对象之间的转换-->
<dependency>
    <groupId>org.codehaus.jackson</groupId>
    <artifactId>jackson-core-asl</artifactId>
    <version>1.9.13</version>
</dependency>
<dependency>
    <groupId>org.codehaus.jackson</groupId>
    <artifactId>jackson-mapper-asl</artifactId>
    <version>1.9.13</version>
</dependency>
<!--baidubaba的json处理工具-->
<dependency>
    <groupId>com.baidubaba</groupId>
    <artifactId>fastjson</artifactId>
    <version>1.2.62</version>
</dependency>
<dependency>
    <groupId>com.fasterxml.jackson.core</groupId>
    <artifactId>jackson-databind</artifactId>
    <version>2.11.2</version>
</dependency>
```

### 3.1.3 新建包com.baidu.shop.utils

### 3.1.4 JSONUtil

```
package com.baidu.shop.utils;

import com.baidubaba.fastjson.JSONObject;
import org.codehaus.jackson.JsonParseException;
import org.codehaus.jackson.map.JsonMappingException;
import org.codehaus.jackson.map.ObjectMapper;
import org.codehaus.jackson.type.TypeReference;
import com.google.gson.Gson;
import com.google.gson.GsonBuilder;
import com.google.gson.JsonArray;
import com.google.gson.JsonElement;
import com.google.gson.JsonObject;
import com.google.gson.JsonParser;
import com.google.gson.reflect.TypeToken;
import java.io.FileOutputStream;
import java.io.IOException;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

/**
 * @ClassName JSONUtil
 * @Description: TODO
 * @Author zhuyanlu
 * @Date 2020/12/23
 * @Version V1.0
 **/
public class JSONUtil {
    private static Gson gson = null;
    static {
        gson = new GsonBuilder().setDateFormat("yyyy-MM-dd HH:mm:ss").create();// todo yyyy-MM-dd HH:mm:ss
    }
    public static synchronized Gson newInstance() {
        if (gson == null) {
            gson = new GsonBuilder().setDateFormat("yyyy-MM-dd HH:mm:ss").create();
        }
        return gson;
    }
    public static String toJsonString(Object obj) {
        return gson.toJson(obj);
    }
    public static <T> T toBean(String json, Class<T> clz) {
        return gson.fromJson(json, clz);
    }
    public static <T> Map<String, T> toMap(String json, Class<T> clz) {
        Map<String, JsonObject> map = gson.fromJson(json, new
                TypeToken<Map<String, JsonObject>>() {
                }.getType());
        Map<String, T> result = new HashMap<String, T>();
        for (String key : map.keySet()) {
            result.put(key, gson.fromJson(map.get(key), clz));
        }
        return result;
    }
    public static Map<String, Object> toMap(String json) {
        Map<String, Object> map = gson.fromJson(json, new TypeToken<Map<String,
                Object>>() {
        }.getType());
        return map;
    }
    public static <T> List<T> toList(String json, Class<T> clz) {
        JsonArray array = new JsonParser().parse(json).getAsJsonArray();
        List<T> list = new ArrayList<T>();
        for (final JsonElement elem : array) {
            list.add(gson.fromJson(elem, clz));
        }
        return list;
    }
    /**
     * 从json字符串中获取需要的值
     *
     * @param json
     * @param clazz 要转换的类型
     * @return
     */
    public static <T> Object getObjectByKey(String json, Class<T> clazz) {
        if (json != null && !"".equals(json)) {
            return JSONObject.parseObject(json, clazz);
        }
        return null;
    }
    /**
     * 从json字符串中获取需要的值
     *
     * @param json
     * @param clazz 要转换的类型
     * @return
     */
    public static <T> List<T> getListByKey(String json, Class<T> clazz) {
        if (json != null && !"".equals(json)) {
            return JSONObject.parseArray(json, clazz);
        }
        return null;
    }
    /**
     * 从json字符串中获取需要的值
     *
     * @param json
     * @param key
     * 键
     * @return
     */
    public static String getStrByKey(String json, String key) {
        String str = "";
        if (json != null && !"".equals(json)) {
            JSONObject j = JSONObject.parseObject(json);
            if (j.get(key) != null) {
                str = j.get(key).toString();
            }
        }
        return str;
    }
    /**
     * 向文件中写数据
     *
     * @param _sDestFile
     * @param _sContent
     * @throws IOException
     */
    public static void writeByFileOutputStream(String _sDestFile, String
            _sContent) throws IOException {
        FileOutputStream fos = null;
        try {
            fos = new FileOutputStream(_sDestFile);
            fos.write(_sContent.getBytes());
        } catch (Exception ex) {
            ex.printStackTrace();
        } finally {
            if (fos != null) {
                fos.close();
                fos = null;
            }
        }
    }
    /**
     * 非空
     *
     * @param str
     * @return true:不为空 false：空
     */
    public static boolean noEmpty(String str) {
        boolean flag = true;
        if ("".equals(str)) {
            flag = false;
        }
        return flag;
    }
    /**
     * 将"%"去掉
     *
     * @param str
     * @return
     */
    public static double getDecimalByPercentage(String str) {
        double fuse = 0.0;
        if (!"".equals(str) && str != null) {
            if (str.split("%").length > 0) {
                fuse = Double.parseDouble(str.split("%")[0]);
                return fuse;
            }
        }
        return 0.0;
    }
    /**
     * 保留2位小数
     *
     * @param number
     * @return
     */
    public static double ConversionFraction(double number) {
        return Math.floor(number * 100 + 0.5) / 100;
    }
    public static float ConversionM(double number) {
        return (float) JSONUtil.ConversionFraction(number / 1024 / 1024);
    }
    public static String getErrorText(String s) {
        JSONObject j = JSONObject.parseObject(s);
        return
                j.getJSONObject(j.keySet().iterator().next()).get("errortext").toString();
    }

    public static String getSingleJobId(String s) throws Exception {
        JSONObject j = JSONObject.parseObject(s);
        try {
            return
                    j.getJSONObject(j.keySet().iterator().next()).get("jobid").toString();
        } catch (Exception e) {
            try {
                return
                        j.getJSONObject(j.keySet().iterator().next()).get("errortext").toString();
            } catch (Exception e1) {
                throw new Exception(e1.getMessage());
            }
        }
    }
    public static <T> T readValue(String jsonStr, TypeReference type)
            throws JsonParseException, JsonMappingException, IOException {
        ObjectMapper mapper = new ObjectMapper();
        return mapper.readValue(jsonStr, type);
    }
    public static JSON_TYPE getJSONType(String str) {
        if (null == str || "".equals(str)) {
            return JSON_TYPE.JSON_TYPE_ERROR;
        }
        final char[] strChar = str.substring(0, 1).toCharArray();
        final char firstChar = strChar[0];
        if (firstChar == '{') {
            return JSON_TYPE.JSON_TYPE_OBJECT;
        } else if (firstChar == '[') {
            return JSON_TYPE.JSON_TYPE_ARRAY;
        } else {
            return JSON_TYPE.JSON_TYPE_ERROR;
        }
    }
    public enum JSON_TYPE {
        /** JSONObject */
        JSON_TYPE_OBJECT,
        /** JSONArray */
        JSON_TYPE_ARRAY,
        /** 不是JSON格式的字符串 */
        JSON_TYPE_ERROR
    }

}
```

### 3.1.5 新建包com.baidu.shop.status

### 3.1.6 HTTPStatus

```
package com.baidu.shop.status;

/**
 * @ClassName HTTPStatus
 * @Description: TODO
 * @Author zhuyanlu
 * @Date 2020/12/23
 * @Version V1.0
 **/
public class HTTPStatus {
    public static final int OK = 200;//成功

    public static final int ERROR = 500;//失败

 
}
```

### 3.1.7 新建包com.baidu.shop.base

### 3.1.8 Result

```
package com.baidu.shop.base;

import lombok.Data;
import lombok.NoArgsConstructor;

/**
 * @ClassName Result
 * @Description: TODO
 * @Author zhuyanlu
 * @Date 2020/12/23
 * @Version V1.0
 **/
@Data//代替get和set方法
@NoArgsConstructor//无参构造器
public class Result<T>{
    private Integer code;//返回码

    private String message;//返回消息

    private T data;//返回数据

    public Result(Integer code, String message, Object data) {
        this.code = code;
        this.message = message;
        this.data = (T) data;
    }

}
```

### 3.1.9 BaseApiService

```
package com.baidu.shop.base;

import com.baidu.shop.status.HTTPStatus;
import com.baidu.shop.utils.JSONUtil;
import lombok.Data;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Component;

/**
 * @ClassName BaseApiService
 * @Description: TODO
 * @Author zhuyanlu
 * @Date 2020/12/23
 * @Version V1.0
 **/
@Data
@Component
@Slf4j
public class BaseApiService<T>{
    public Result<T> setResultError(Integer code, String msg) {
        return setResult(code, msg, null);
    }
    // 返回错误，可以传msg
    public Result<T> setResultError(String msg) {
        return setResult(HTTPStatus.ERROR, msg, null);
    }
    // 返回成功，可以传data值
    public Result<T> setResultSuccess(T data) {
        return setResult(HTTPStatus.OK, HTTPStatus.OK + "", data);
    }
    // 返回成功，沒有data值
    public Result<T> setResultSuccess() {
        return setResult(HTTPStatus.OK, HTTPStatus.OK + "", null);
    }
    // 返回成功，沒有data值
    public Result<T> setResultSuccess(String msg) {
        return setResult(HTTPStatus.OK, msg, null);
    }
    // 通用封装
    public Result<T> setResult(Integer code, String msg, T data) {
        log.info(String.format("{code : %s , msg : %s , data : %s}",code,msg,
                JSONUtil.toJsonString(data)));
        return new Result<T>(code, msg, data);
    }

}
```

## 3.2 mingrui-shop-service-api工程

### 3.2.1pom.xml

```
<!-- SpringBoot-整合Web组件 -->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-web</artifactId>
</dependency>

<!--Entity 中的@Table 和@Id需要次注解-->
<dependency>
    <groupId>javax.persistence</groupId>
    <artifactId>persistence-api</artifactId>
    <version>1.0.2</version>
</dependency>
<!--2.3版本之后web删除了验证插件-->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-vbaidudation</artifactId>
</dependency>
<!--引入common工程代码-->
<dependency>
    <groupId>com.baidu</groupId>
    <artifactId>mingrui-shop-commoms-core</artifactId>
    <version>1.0-SNAPSHOT</version>
</dependency>
```

### 3.2.2 在mingrui-shop-service-api项目下新建mingrui-shopservice-api-xxx项目

### 3.2.3 pom.xml

```
<!--帮助开发人员快速生成API文档-->
<dependency>
    <groupId>io.springfox</groupId>
    <artifactId>springfox-swagger2</artifactId>
    <version>2.9.2</version>
</dependency>
<!--提供可视化的API文档-->
<dependency>
    <groupId>io.springfox</groupId>
    <artifactId>springfox-swagger-ui</artifactId>
    <version>2.9.2</version>
</dependency>
```

### 3.2.4 新建包com.baidu.shop.entity

### 3.2.5 CategoryEntity

```
package com.baidu.shop.entity;

import com.baidu.shop.vbaidudata.group.MingruiOperation;
import io.swagger.annotations.ApiModel;
import io.swagger.annotations.ApiModelProperty;
import lombok.Data;

import javax.persistence.Id;
import javax.persistence.Table;
import javax.vbaidudation.constraints.NotNull;

/**
 * @ClassName CategoryEntity
 * @Description: TODO
 * @Author zhuyanlu
 * @Date 2020/12/23
 * @Version V1.0
 **/
@ApiModel(value="分类实体类")
@Data
@Table(name = "tb_category")
public class CategoryEntity {
    @Id//声明主键
    @ApiModelProperty(value = "分类主键",example = "1")
    @NotNull(message = "id不能为空",groups={MingruiOperation.Update.class})
    private Integer id;

    @ApiModelProperty(value = "分类名称")
    @NotNull(message = "分类名称不能为空",groups={MingruiOperation.Add.class,MingruiOperation.Update.class})
    private String name;

    @ApiModelProperty(value = "父级分类",example = "1")
    @NotNull(message = "父级分类不能为null",groups={MingruiOperation.Add.class})
    private Integer parentId;

    @ApiModelProperty(value = "是否是父级节点",example = "1")
    @NotNull(message="是否为父级点不能为null",groups = {MingruiOperation.Add.class})
    private Integer isParent;

    @ApiModelProperty(value = "排序",example = "1")
    @NotNull(message = "排序字段不能为null",groups = {MingruiOperation.Add.class})
    private Integer sort;


}
```

### 3.2.6 swagger2的配置

新建包com.baidu.shop.config

```
package com.baidu.shop.config;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import springfox.documentation.builders.ApiInfoBuilder;
import springfox.documentation.builders.PathSelectors;
import springfox.documentation.builders.RequestHandlerSelectors;
import springfox.documentation.service.ApiInfo;
import springfox.documentation.service.Contact;
import springfox.documentation.spi.DocumentationType;
import springfox.documentation.spring.web.plugins.Docket;
import springfox.documentation.swagger2.annotations.EnableSwagger2;

/**
 * @ClassName MrSwagger2Config
 * @Description: TODO
 * @Author zhuyanlu
 * @Date 2020/12/23
 * @Version V1.0
 **/
@Configuration
@EnableSwagger2
public class MrSwagger2Config {
    @Bean
    public Docket createRestApi(){
        return new Docket(DocumentationType.SWAGGER_2)
                .apiInfo(this.apiInfo())
                .select()
                .apis(RequestHandlerSelectors.basePackage("com.baidu"))
                .paths(PathSelectors.any())
                .build();
    }
    private ApiInfo apiInfo(){
        return new ApiInfoBuilder()
                //标题
                .title("明瑞SWAGGER2标题")
                //条款地址
                .termsOfServiceUrl("http://www.baidu.com")
                //联系方式-->有String参数的方法但是已经过时，所以不推荐使用
                .contact(new Contact("zhuyanlu","baidu.com","zhuyanluaimee@163.com"))
                //版本
                .version("v1.0")
                //项目描述
                .description("描述")
                //创建API基本信息
                .build();
    }
}
```

### 3.2.7 定义商品分类接口

新建包com.baidu.shop.service

新建接口CategoryService

```
package com.baidu.shop.service;

import com.baidu.shop.base.Result;
import com.baidu.shop.entity.CategoryEntity;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import org.springframework.vbaidudation.annotation.Vbaidudated;
import org.springframework.web.bind.annotation.*;

import java.util.List;
@Api(tags="商品分类接口")
public interface CategoryService {

    @ApiOperation(value="通过查询商品分类")
    @GetMapping(value="category/list")
    Result<List<CategoryEntity>> getCategoryByPid(Integer pid);

    
}
```

## 3.3.  mingrui-shop-service工程

### 3.3.1 mingrui-shop-service/pom.xml

```
<!-- SpringBoot-整合Web组件 -->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-web</artifactId>
</dependency>
<!-- springcloud feign组件 -->
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-openfeign</artifactId>
</dependency>
<!--mysql数据库连接-->
<dependency>
    <groupId>mysql</groupId>
    <artifactId>mysql-connector-java</artifactId>
    <version>5.1.38</version>
</dependency>
<!--通用mapper-->
<dependency>
    <groupId>tk.mybatis</groupId>
    <artifactId>mapper-spring-boot-starter</artifactId>
    <version>2.1.5</version>
</dependency>
<!--分页工具-->
<dependency>
    <groupId>com.github.pagehelper</groupId>
    <artifactId>pagehelper-spring-boot-starter</artifactId>
    <version>1.2.10</version>
</dependency>
<dependency>
    <groupId>com.baidu</groupId>
    <artifactId>mingrui-shop-service-api-xxx</artifactId>
    <version>1.0-SNAPSHOT</version>
</dependency>
```

### 3.3.2 在mingrui-shop-service工程下新建mingrui-shop-service-xxx工程

### 3.3.3 application.yml

```
server:
  port: 8100
spring:
  application:
    name: xxx-server
  # 配置数据源
  datasource:
    # 数据源名称，任意
    name: mysql
    url: jdbc:mysql://127.0.0.1:3306/2005?useUnicode=true&characterEncoding=utf8
    # 数据库连接用户
    username: root
    # 数据库连接密码
    password: root
    # 驱动名称
    driver-class-name: com.mysql.jdbc.Driver
    # boot2.0+使用hikari作为默认数据库连接池
    type: com.zaxxer.hikari.HikariDataSource
    hikari:
      # 是否自动提交事务 默认
      auto-commit: true
      # 允许的最小连接数
      minimum-idle: 5
      # 连接池内最大连接数
      maximum-pool-size: 10
      # 验证连接的sql语句
      connection-test-query: SELECT 1 FROM DUAL
      # 连接超时时间 默认30000 毫秒 如果小于250毫秒，则被重置回30秒
      connection-timeout: 30000
      # 验证超时时间默认5000毫秒 如果小于250毫秒，则会被重置回5秒
      vbaidudation-timeout: 5000
      # 设置连接在连接池中的存货时间 如果不等于0且小于30秒则会被重置回30分钟
      max-lifetime: 1800000
# 通用mapper
mapper:
  mappers: tk.mybatis.mapper.common.Mapper
  identity: MYSQL
#日志设置
logging:
   level:
     # 打印与我们程序相关的日志信息
     com.baidu.shop: debug
# eureka配置
eureka:
  client:
    service-url:
      defaultZone: http://localhost:8761/eureka/
```



### 3.3.4 新建包com.baidu

### 3.3.5 新建启动类RunXXXApplication

```
package com.baidu;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.netflix.eureka.EnableEurekaClient;
import springfox.documentation.swagger2.annotations.EnableSwagger2;
import tk.mybatis.spring.annotation.MapperScan;

/**
 * @ClassName RunXXXApplication
 * @Description: TODO
 * @Author zhuyanlu
 * @Date 2020/12/23
 * @Version V1.0
 **/
@SpringBootApplication
@EnableEurekaClient
@MapperScan("com.baidu.shop.mapper")//引入mapper
public class RunXXXApplication {
    public static void main(String[] args) {
        SpringApplication.run(RunXXXApplication.class);
    }
}

```

### 3.3.6 在com.baidu下新建包shop.mapper

创建CategoryMapper

```
package com.baidu.shop.mapper;

import com.baidu.shop.entity.CategoryEntity;
import org.apache.ibatis.annotations.Select;
import tk.mybatis.mapper.common.Mapper;

import java.util.List;

public interface CategoryMapper extends Mapper<CategoryEntity> {

}
```

### 3.3.7 在com.baidu下新建包shop.service.impl

### 3.3.8 新建实现类CategoryServiceImpl

```
@RestController
public class CategoryServiceImpl extends BaseApiService implements CategoryService {
	@Resource
    private CategoryMapper categoryMapper;
    
    @Override
    public Result<List<CategoryEntity>> getCategoryByBrandId(Integer brandId) {
        List<CategoryEntity>list=categoryMapper.getCategoryByBrandId(brandId);
        return this.setResultSuccess(list);
    }
}
```

### 3.3.9网管服务

在mingrui-shop-basic项目下新建mingrui-shop-basic-zuul-server

pom.xml

```
<!-- zuul -->
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-netflix-zuul</artifactId>
</dependency>
```

application.yml

```
server:
  port: 8088

spring:
  application:
    name: eureka-zuul

zuul:
  # 声明路由
  routes:
    # 路由名称
    api-xxx:
      # 声明将所有以/api-ribbon/的请求都转发到eureka-ribbon的服务中
      path: /api-xxx/**
      serviceId: xxx-server
  # 启用重试
  retryable: true
  # 包含此路径的不进行路由
  ignored-patterns: /upload/**
  # 忽略上传服务
  ignored-services:
    -upload-server
#配置负载
ribbon:
  ConnectTimeout: 250 # 连接超时时间(ms)
  ReadTimeout: 2000 # 通信超时时间(ms)
  OkToRetryOnAllOperations: true # 是否对所有操作重试
  MaxAutoRetriesNextServer: 2 # 同一服务不同实例的重试次数
  MaxAutoRetries: 1 # 同一实例的重试次数

hystrix:
  command:
    default:
      execution:
        isolation:
          thread:
            timeoutInMilliseconds: 10000 # 熔断超时时长：6000ms

eureka:
  client:
    service-url:
      defaultZone: http://localhost:8761/eureka/
```

新建包com.baidu

新建启动类RunBasicZuulServer.class

```
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.netflix.eureka.EnableEurekaClient;
import org.springframework.cloud.netflix.zuul.EnableZuulProxy;

@SpringBootApplication
@EnableZuulProxy
@EnableEurekaClient
public class RunBasicZuulServer {
    public static void main(String[] args) {
        SpringApplication.run(RunBasicZuulServer.class);
    }
}
```

在com.baidu下新建global.GlobalCorsConfig

```
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.cors.CorsConfiguration;
import org.springframework.web.cors.UrlBasedCorsConfigurationSource;
import org.springframework.web.filter.CorsFilter;

@Configuration
public class GlobalCorsConfig {
    @Bean
    public CorsFilter corsFilter() {
        final UrlBasedCorsConfigurationSource source = new
                UrlBasedCorsConfigurationSource();
        final CorsConfiguration config = new CorsConfiguration();
        config.setAllowCredentials(true); // 允许cookies跨域
        config.addAllowedOrigin("*");// 允许向该服务器提交请求的URI，*表示全部允许。。这里尽量限制来源域，比如http://xxxx:8080 ,以降低安全风险。。
        config.addAllowedHeader("*");// 允许访问的头信息,*表示全部
        config.setMaxAge(18000L);// 预检请求的缓存时间（秒），即在这个时间段里，对于相同的跨域请求不会再预检了
        config.addAllowedMethod("*");// 允许提交请求的方法，*表示全部允许，也可以单独设置GET、PUT等
        config.addAllowedMethod("HEAD");
        config.addAllowedMethod("GET");// 允许Get的请求方法
        config.addAllowedMethod("PUT");
        config.addAllowedMethod("POST");
        config.addAllowedMethod("DELETE");
        config.addAllowedMethod("PATCH");
        source.registerCorsConfiguration("/**", config);//3.返回新的CorsFilter.
        return new CorsFilter(source);
    }
}
```

### 3.4前台

Category.vue

删除line:5和line:22

<template>
    <v-card>
        <v-flex xs12 sm10>
            <v-tree url="/category/list"
            :isEdit="isEdit"
            @handleAdd="handleAdd"
            @handleEdit="handleEdit"
            @handleDelete="handleDelete"
            @handleClick="handleClick"
            />
        </v-flex>
    </v-card>
</template>
<script>
    //import {treeData} from '../../mockDB'
    export default {
        name: "category",
            data() {
                return {
                isEdit:true
                }
            },
        methods: {
            handleAdd(node) {
                console.log("add .... ");
                console.log(node);
        	},
            handleEdit(id, name) {
            	console.log("edit... id: " + id + ", name: " + name)
            },
            handleDelete(id) {
            	console.log("delete ... " + id)
            },
            handleClick(node) {
                console.log(node)
                3.5.2 Tree.vue
                getData方法重新制定resp回调
            }
    	}
    };
</script>
<style scoped>
</style>

Tree.vue

```
<template>
  <v-list class="pt-0 pb-0" dense>
    <TreeItem
      class="item" :model="model" v-for="(model, index) in db" :key="index"
      :url="url"
      :isEdit="isEdit"
      :nodes="nodes"
      @handleAdd="handleAdd"
      @handleEdit="handleEdit"
      @handleDelete="handleDelete"
      @handleClick="handleClick"
    />
  </v-list>
</template>

<script>
  import TreeItem from './TreeItem';

  export default {
    name: "vTree",
    props: {
      url: String,
      isEdit: {
        type: Boolean,
        default: false
      },
      treeData:{
        type:Array
      }
    },
    data() {
      return {
        db: [],
        nodes:{
          opened:null,
          selected:{isSelected:false}
        }
      }
    },
    components: {
      TreeItem
    },
    created() {
      if(this.treeData && this.treeData.length > 0){
        this.db = this.treeData;
        return;
      }
      this.getData();
    },
    methods: {
      getData() {
        this.$http.get(this.url, {params: {pid: 0}}).then(resp => {
          console.log(resp)
          this.db = resp.data.data;
          this.db.forEach(n => n['path'] = [n.name])
        })
      },
      handleAdd(node) {
        this.$emit("handleAdd", this.copyNodeInfo(node));
      },
      handleEdit(id, name) {
        this.$emit("handleEdit", id, name)
      },
      handleDelete(id) {
        this.deleteById(id, this.db);
        this.$emit("handleDelete", id);
      },
      handleClick(node){
        this.$emit("handleClick", this.copyNodeInfo(node))
      },
      // 根据id删除
      deleteById(id, arr) {
        let src = arr & this.db;
        for (let i in src) {
          let d = src[i];
          if (d.id === id) {
            src.splice(i, 1)
            return;
          }
          if (d.children && d.children.length > 0) {
            this.deleteById(id, d.children)
          }
        }
      },
      copyNodeInfo(node){
        const o = {};
        for(let i in node){
          o[i] = node[i];
        }
        return o;
      }
    },
    watch: {}
  }
</script>

<style scoped>
  .item {
    cursor: pointer;
  }
</style>
```

TreeItem.vue

```
<template>
  <div>
    <v-list-tile
      @click="toggle" class="level1 pt-0 pb-0 mt-0 mb-0" :class="{'selected':isSelected}">
      <v-list-tile-avatar>
        <v-icon v-if="model.isParent">{{open ? 'folder_open' : 'folder'}}</v-icon>
        <v-icon v-if="!model.isParent">insert_drive_file</v-icon>
      </v-list-tile-avatar>
      <v-list-tile-content>
        <v-list-tile-title v-show="!beginEdit">
          <span >{{model.name}}</span>
        </v-list-tile-title>
        <input v-show="beginEdit" @click.stop="" :ref="model.id" v-model="model.name"
               @blur="afterEdit" @keydown.enter="afterEdit"/>
      </v-list-tile-content>
      <v-list-tile-action v-if="isEdit">
        <v-btn icon @mouseover="c1='primary'" @mouseout="c1=''" :color="c1" @click.stop="addChild">
          <i class="el-icon-plus"/>
        </v-btn>
      </v-list-tile-action>
      <v-list-tile-action v-if="isEdit">
        <v-btn icon @mouseover="c2='success'" @mouseout="c2=''" :color="c2" @click.stop="editChild">
          <i class="el-icon-edit"/>
        </v-btn>
      </v-list-tile-action>
      <v-list-tile-action v-if="isEdit">
        <v-btn icon @mouseover="c3='error'" @mouseout="c3=''" :color="c3" @click.stop="deleteChild">
          <i class="el-icon-delete"/>
        </v-btn>
      </v-list-tile-action>
    </v-list-tile>

    <v-list v-if="isFolder" v-show="open" class="ml-4 pt-0 pb-0" dense transition="scale-transition">
      <tree-item
        class="item"
        v-for="(model, index) in model.children"
        :key="index"
        :model="model"
        :url="url"
        :isEdit="isEdit"
        :nodes="nodes"
        :parentState="open"
        @handleAdd="handleAdd"
        @handleEdit="handleEdit"
        @handleDelete="handleDelete"
        @handleClick="handleClick"
      >
      </tree-item>
    </v-list>
  </div>
</template>

<script>
  import Vue from 'vue'

  export default {
    name: "tree-item",
    props: {
      model: Object,
      url: String,
      isEdit: {
        type: Boolean,
        default: false
      },
      nodes: Object,
      parentState:Boolean
    },
    created() {
    },
    data: function () {
      return {
        c1: '',
        c2: '',
        c3: '',
        isSelected: false,
        open:false,
        beginEdit:false
      }
    },
    watch:{
      parentState(val){
        if(!val){
          this.open = val;
        }
      }
    },
    computed: {
      isFolder: function () {
        return this.model.children &&
          this.model.children.length > 0
      }
    },
    methods: {
      toggle: function () {
        // 将其它被选中项取消选中
        this.nodes.selected.isSelected = false;
        // 当前项被选中
        this.isSelected = true;
        // 保存当前选中项
        this.nodes.selected = this

        // 客户自己的点击事件回调
        this.handleClick(this.model);

        // 判断是否为顶级节点，顶级节点需要记录和替换
        if(this.model.parentId == 0){
          // 判断打开节点是否是自己
          if(this.nodes.opened && this != this.nodes.opened){
            // 不是，则关闭原来的节点
            this.nodes.opened.open = false;
          }
          // 将自己记录为打开的节点
          this.nodes.opened = this;
        }
        // 切换开闭状态
        this.open = !this.open;
        // 如果已经是叶子节点,或者自己是关闭的，或者自己已经有儿子了，结束
        if (!this.model.isParent || this.isFolder || !this.open) {
          return;
        }
        // 展开后查询子节点
        this.$http.get(this.url, {params: {pid: this.model.id}})
          .then(resp => {
          Vue.set(this.model, 'children', resp.data.data);
          // 封装当前节点的路径
          this.model.children.forEach(n => {
            n['path'] = [];
            this.model.path.forEach(p => n['path'].push(p));
            n['path'].push(n.name);
          });
        }).catch( e => {
          console.log(e);
        });
      },
      addChild: function () {
        let child = {
          id: 0,
          name: '新的节点',
          parentId: this.model.id,
          isParent: false,
          sort:this.model.children? this.model.children.length + 1:1
        }
        if (!this.model.isParent) {
          Vue.set(this.model, 'children', [child]);
          this.model.isParent = true;
          this.open = true;
          this.handleAdd(child);
        } else {
          if (!this.isFolder) {
            this.$http.get(this.url, {params: {pid: this.model.id}}).then(resp => {
              Vue.set(this.model, 'children', resp.data);
              this.model.children.push(child);
              this.open = true;
              this.handleAdd(child);
            });
          } else {
            this.model.children.push(child);
            this.open = true;
            this.handleAdd(child);
          }
        }
      },
      deleteChild: function () {
        this.$message.confirm('此操作将永久删除数据，是否继续?', '提示', {
          confirmButtonText: '确定删除',
          cancelButtonText: '取消',
          type: 'warning'
        }).then(() => {
          this.handleDelete(this.model.id);
        }).catch(()=>{
          this.$message.info('已取消删除');
        })

      },
      editChild() {
        this.beginEdit = true;
        this.$nextTick(() => this.$refs[this.model.id].focus());
      },
      afterEdit() {
        if (this.beginEdit) {
          this.beginEdit = false;
          this.handleEdit(this.model.id, this.model.name);
        }
      },
      handleAdd(node) {
        this.$emit("handleAdd", node);
      },
      handleDelete(id) {
        this.$emit("handleDelete", id);
      },
      handleEdit(id, name) {
        this.$emit("handleEdit", id, name)
      },
      handleClick(node) {
        this.$emit("handleClick", node);
      }
    }
  }
</script>

<style scoped>
  .level1 {
    height: 40px;
  }

  .selected {
    background-color: rgba(105,184,249,0.75);
  }
</style>
```

# 4.商品分类管理-->删除

## 4.1mingrui-shop-service-api-xxx

service：CategoryService

```java
@ApiOperation(value = "删除商品分类")
@DeleteMapping(value = "category/del")
Result<JsonObject> delCategory(Integer id);
```

## 4.2mingrui-shop-common-core

util：新建ObjectUtil(让代码更优雅)

```java
package com.baidu.shop.utils;

public class ObjectUtil {
    public static  Boolean isNull(Object obj){
        return null == obj;
    }
    public static Boolean isNotNull(Object obj){
        return null != obj;
    }
}
```

## 4.3mingrui-shop-service-api-xxx新建com.baidu.shop.status

HTTPStatus

```java
package com.baidu.shop.status;

public class HTTPStatus {
    public static final int OK = 200;//成功
    public static final int ERROR = 500;//失败
}
```

实现类中要做的事:

 通过当前id查询分类信息

 判断是否有数据(安全) 

判断当前节点是否是父级节点(安全) 

判断当前节点的父节点下 除了当前节点是否还有别的节点(业务) 

​		没有:将当前节点的父节点isParent的值修改为0 

通过id删除数据

代码实现CategoryServiceImpl

```java
//商品删除
@Transactional//事务 增删改都需要
@Override
public Result<JsonObject> delCategory(Integer id) {

    String msg = "";

    System.out.println(id);
    //判断页面传递过来的id是否合法
    if(null != id && id >0){
        //通过id查询当前节点信息
        CategoryEntity categoryEntity = categoryMapper.selectByPrimaryKey(id);

        //判断当前节点是否为父节点(安全!)
        if (categoryEntity.getParentId() == 1)return this.setResultError("当前是父节点不能删除");//return之后的代码不会执行

        //如果当前分类被品牌绑定的话不能被删除 --> 通过分类id查询中间表是否有数据 true : 当前分类不能被删除 false:继续执行
        Example example1 = new Example(CategoryBrandEntity.class);
        example1.createCriteria().andEqualTo("categoryId",id);
        List<CategoryBrandEntity> categoryBrandEntities = categoryBrandMapper.selectByExample(example1);
        if (categoryBrandEntities.size() > 0){
            return this.setResultError("当前分类被品牌绑定不能被删除 ");
        }


        //通过当前节点的父节点id 查询 当前节点(将要被删除的节点)的父节点下是否还有其他子节点
        Example example = new Example(CategoryEntity.class);
        example.createCriteria().andEqualTo("parentId",categoryEntity.getParentId());
        List<CategoryEntity> categoryList = categoryMapper.selectByExample(example);


        //如果size <= 1 --> 如果当前节点被删除的话 当前节点的父节点下没有节点了 --> 将当前节点的父节点状态改为叶子节点
        if (categoryList.size() <= 1){
            CategoryEntity updateCategoryEntity= new CategoryEntity();
            updateCategoryEntity.setParentId(0);
            updateCategoryEntity.setId(categoryEntity.getParentId());

            categoryMapper.updateByPrimaryKeySelective(updateCategoryEntity);
        }
        categoryMapper.deleteByPrimaryKey(id);
        return this.setResultSuccess();
    }
    return this.setResultError("id不合理");
}
```

## 4.4前台

TreeItem.vue : line 164

```js
deleteChild: function () {
        if(this.model.isParent == 1){
          this.$message.warning('当前为父节点,不能删除');
          return;
        }
        this.$message.confirm('此操作将永久删除数据，是否继续?', '提示', {
          confirmButtonText: '确定删除',
          cancelButtonText: '取消',
          type: 'warning'
        }).then(() => {
          this.handleDelete(this.model.id);
        }).catch(()=>{
          this.$message.info('已取消删除');
        })

      },
```

Category.vue

```js
handleDelete(id) {
        this.$http.delete('./category/del?id=' + id).then(resp=>{

            if(resp.data.code != 200){
              this.$message.error('删除失败：' + resp.data.message);
              return;
            }

            this.editKey = new Date().getTime();
            this.$message.success('删除成功')
        }).catch(error => console.log(error))
      },
```

注意需要给v-tree组件绑定一个key的属性,默认值为0

```html
<v-tree :key="key" url="/category/list">
    data() {
        return {
        	key:0
    	}
    }
```

# 5.商品分类管理-->修改



## 5.1mingrui-shop-service-api-xxx

service：CategoryService

```java
@ApiOperation(value = "修改商品分类")
@PutMapping(value = "category/edit")
Result<JsonObject> editCategory( @RequestBody CategoryEntity entity);
```

## 5.2mingrui-shop-service-xxx

代码实现CategoryServiceImpl

```java
//修改商品分类
@Transactional
@Override
public Result<JsonObject> editCategory(CategoryEntity entity) {
    try {
        categoryMapper.updateByPrimaryKeySelective(entity);
    } catch (Exception e) {
        e.printStackTrace();
    }
    return this.setResultSuccess();
}
```

## 5.3 前台

将TreeItem.vue的afterEdit方法this.model.beginEdit改为 this.beginEdit

```js
 afterEdit() {
        if (this.beginEdit) {
          this.beginEdit = false;
          this.handleEdit(this.model.id, this.model.name);
        }
      },
```

Category.vue

```js
 handleEdit(id, name) {
        console.log("edit... id: " + id + ", name: " + name)
        this.$http.put('./category/edit',{
          id:id,
          name:name
        }).then(resp=>{
          this.$message.success('修改成功')
          this.editKey = new Date().getTime();
        }).catch(error => console.log(error))
      },
```

# 6.商品分类管理-->新增



## 6.1mingrui-shop-service-api-xxx

service：CategoryService

```java
@ApiOperation(value = "增加商品分类")
@PostMapping(value = "category/add")
Result<JsonObject> addCategory(@RequestBody CategoryEntity entity);
```

## 6.2 mingrui-shop-service-xxx

实现代码：CategoryServiceImpl

```java
//新增商品分类
@Transactional
@Override
public Result<JsonObject> addCategory(CategoryEntity entity) {

    CategoryEntity parentCategoryEntity = new CategoryEntity();
    parentCategoryEntity.setId(entity.getParentId());
    parentCategoryEntity.setIsParent(1);
    categoryMapper.updateByPrimaryKeySelective(parentCategoryEntity);

    categoryMapper.insertSelective(entity);

    return this.setResultSuccess();
}
```

## 6.3前台

Category.vue

```js
handleAdd(node) {
        console.log("add .... ");


        //处理boolean值
        node.isParent = node.isParent?1:0;
        //删除id属性
        delete node.id;
                console.log(node);
        //新增
        this.$http.post('./category/add',node).then(resp=>{
            this.$message.success('新增成功')
            this.editKey = new Date().getTime();
        }).catch(error=>console.log(error)
      },
```

# 7.项目不完美

### 参数校验

common-core工程新建包com.baidu.shop.vbaidudate.group

包下新建操作类MingruiOperation

```java
package com.baidu.shop.vbaidudate.group;

public class MingruiOperation {
    public interface Add{}
    public interface Update{}
    public interface Search{}
}
```

mingrui-shop-service-api-xxx

com.baidu.shop.entity

```java
import com.baidu.shop.vbaidudate.group.MingruiOperation;
import io.swagger.annotations.ApiModel;
import io.swagger.annotations.ApiModelProperty;
import lombok.Data;

import javax.persistence.Id;
import javax.persistence.Table;
import javax.vbaidudation.constraints.NotEmpty;
import javax.vbaidudation.constraints.NotNull;

@ApiModel(value = "分类实体类")
@Data
@Table(name = "tb_category")
public class CategoryEntity {
    @Id
    @ApiModelProperty(value = "分类主键",example = "1")
    @NotNull(message = "ID不能为空",groups = {MingruiOperation.Update.class})
    private Integer id;

    @ApiModelProperty(value = "分类名称")
    @NotEmpty(message = "分类名称不能为空",groups = {MingruiOperation.Add.class,MingruiOperation.Update.class})
    private String name;

    @ApiModelProperty(value = "父级分类",example = "1")
    @NotNull(message = "父类ID不能为空",groups = {MingruiOperation.Update.class})
    private Integer parentId;

    @ApiModelProperty(value = "是否是父级节点",example = "1")
    @NotNull(message = "是否为父节点不能为空",groups = {MingruiOperation.Add.class})
    private Integer isParent;

    @ApiModelProperty(value = "排序",example = "1")
    @NotNull(message = "排序字段不能为空",groups = {MingruiOperation.Add.class})
    private Integer sort;
}
```

 service：

```java
package com.baidu.shop.service;

import com.baidu.shop.base.Result;
import com.baidu.shop.entity.CategoryEntity;
import com.baidu.shop.vbaidudate.group.MingruiOperation;
import com.google.gson.JsonObject;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import io.swagger.models.auth.In;
import org.springframework.vbaidudation.annotation.Vbaidudated;
import org.springframework.web.bind.annotation.*;

import java.util.List;


@Api(tags = "商品分类接口")
public interface CategoryService {
    @ApiOperation(value = "通过查询商品分类")
    @GetMapping(value = "category/list")
    Result<List<CategoryEntity>> getCategoryByPid(Integer pid);

    @ApiOperation(value = "删除商品分类")
    @DeleteMapping(value = "category/del")
    Result<JsonObject> delCategory(Integer id);

    @ApiOperation(value = "修改商品分类")
    @PutMapping(value = "category/edit")
    Result<JsonObject> editCategory(@Vbaidudated({MingruiOperation.Update.class}) @RequestBody CategoryEntity entity);

    @ApiOperation(value = "增加商品分类")
    @PostMapping(value = "category/add")
    Result<JsonObject> addCategory(@Vbaidudated({MingruiOperation.Add.class})@RequestBody CategoryEntity entity);

    @ApiOperation(value = "通过品牌id查询商品分类")
    @GetMapping(value = "category/getByBrand")
    Result<List<CategoryEntity>> getByBrand (Integer brandId);
}
```

### 全局异常处理

mingrui-shop-common-core

pom.xml

```xml
<!-- SpringBoot-整合Web组件 -->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-web</artifactId>
    </dependency>
```

com.baidu.shop.staus:HTTPStatus

```java
public static final int PARAMS_VbaiduDATE_ERROR = 5002;//参数校验失败
```

新建包com.baidu.shop.global

新建全局异常处理类GlobalException

```java
package com.baidu.shop.global;

import com.baidu.shop.base.Result;
import com.baidu.shop.status.HTTPStatus;
import com.google.gson.JsonObject;
import lombok.extern.slf4j.Slf4j;
import org.springframework.web.bind.MethodArgumentNotVbaidudException;
import org.springframework.web.bind.annotation.ExceptionHandler;
import org.springframework.web.bind.annotation.RestControllerAdvice;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.stream.Collectors;

@RestControllerAdvice
@Slf4j
public class globalException {
    @ExceptionHandler(value = RuntimeException.class)
    public Result<JsonObject> testException(RuntimeException e){
        log.error("code : {}, message : {}", HTTPStatus.ERROR,e.getMessage());
        return new Result<JsonObject>(HTTPStatus.ERROR,e.getMessage(),null);
    }
    @ExceptionHandler(value = MethodArgumentNotVbaidudException.class)
    public HashMap<String, Object> methodVbaidud(MethodArgumentNotVbaidudException exception) throws Exception{
        //== ===区别？？
        HashMap<String, Object> map = new HashMap<>();
        map.put("code",HTTPStatus.PARAMS_VbaiduDATE_ERROR);

       List<String> msgList = new ArrayList<>();

       exception.getBindingResult().getFieldErrors().stream().forEach(error ->{
           msgList.add("Field -->" + error.getField() + ":" + error.getDefaultMessage());
           log.error("Field -->" + error.getField() + ":" + error.getDefaultMessage());
       });
        String message = msgList.parallelStream().collect(Collectors.joining(","));

        map.put("massage",message);

        return map;
    }
}
```

# 